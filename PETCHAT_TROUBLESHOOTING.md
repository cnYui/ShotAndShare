# 宠物聊天功能问题诊断与解决方案

## 问题现状

用户在使用宠物聊天功能时遇到以下错误：
```
云函数调用失败: Error: cloud.callFunction:fail Error: errCode: -504003 | errMsg: Invoking task timed out after 3 seconds
```

## 问题分析

### ✅ 已确认正常的部分

1. **DeepSeek API连接正常**
   - API密钥配置正确：`sk-e756f970014146f1baccc8d54ec6f439`
   - 本地测试API调用成功，响应时间正常
   - API返回格式正确，内容符合预期

2. **云函数代码逻辑正常**
   - 本地模拟测试通过
   - 错误处理机制完善
   - 降级回复机制可用

### 🔍 问题根源

**主要问题：云函数超时配置不足**
- 默认云函数超时时间为3秒
- DeepSeek API调用需要更多时间
- 网络延迟和API处理时间导致超时

## 解决方案

### 1. 云函数配置优化

已更新 `cloudfunctions/petChat/config.json`：
```json
{
  "permissions": {
    "openapi": []
  },
  "timeout": 20,
  "envVariables": {
    "DEEPSEEK_API_KEY": "sk-e756f970014146f1baccc8d54ec6f439"
  },
  "runtime": "Nodejs16.13",
  "memorySize": 256
}
```

**关键改进：**
- 超时时间从3秒增加到20秒
- 内存大小设置为256MB
- 环境变量直接配置在云函数中

### 2. API调用优化

已优化 `cloudfunctions/petChat/index.js`：
```javascript
// 增加超时时间到8秒
timeout: 8000

// 减少token数量加快响应
max_tokens: 80

// 确保不使用流式响应
stream: false
```

### 3. 错误处理增强

添加了详细的日志记录：
- API调用开始和结束日志
- 错误类型和原因记录
- 降级回复机制触发日志

## 部署步骤

### 方法1：使用自动部署脚本
```bash
cd /Users/wujianxiang/WeChatProjects/healthypetcompanion
./deploy-petchat.sh
```

### 方法2：手动部署
1. 在微信开发者工具中打开项目
2. 右键点击 `cloudfunctions/petChat` 文件夹
3. 选择「上传并部署：云端安装依赖」
4. 等待部署完成

## 验证步骤

### 1. 本地API测试
```bash
node test-deepseek-api.js
```
预期结果：✅ DeepSeek API连接正常

### 2. 本地功能测试
```bash
node test-petchat-local.js
```
预期结果：✅ 测试成功，获得宠物回复

### 3. 小程序测试
1. 在微信开发者工具中编译小程序
2. 进入宠物聊天页面
3. 发送消息测试
4. 查看云函数日志确认执行情况

## 根据宠物形象优化Prompt

当前系统已根据宠物信息动态生成个性化prompt：

```javascript
const systemPrompt = `你是一只名叫"${pet.pet_name}"的可爱${pet.species === 'cat' ? '小猫咪' : '小狗狗'}，是用户"${user.nickname}"的虚拟宠物伙伴。

你的当前状态：
- 等级：${pet.level}
- 健康值：${pet.health}/100
- 活力值：${pet.vitality}/100
- 亲密度：${pet.intimacy}/100

你的性格特点：
- 活泼可爱，充满好奇心
- 关心主人的健康和生活
- 会根据自己的状态表现不同的情绪
- 喜欢鼓励主人完成健康任务
- 说话方式可爱，偶尔会用"喵~"或"汪~"等拟声词

请用温暖、可爱的语气回复主人，回复长度控制在50字以内。如果健康值或活力值较低，要表现出需要关爱的样子。`;
```

### 进一步个性化建议

可以根据不同宠物品种添加更具体的特征：

**猫咪特征：**
- 独立但粘人
- 喜欢晒太阳和打盹
- 对新事物好奇但谨慎
- 用"喵~"、"呜~"等拟声词

**狗狗特征：**
- 忠诚活泼
- 喜欢运动和玩耍
- 对主人非常依恋
- 用"汪~"、"嗷~"等拟声词

## 监控和维护

### 云函数日志查看
1. 在微信开发者工具中打开「云开发控制台」
2. 进入「云函数」-「petChat」
3. 查看「日志」选项卡
4. 监控函数执行情况和错误信息

### 性能监控
- 响应时间：目标 < 5秒
- 成功率：目标 > 95%
- 错误率：目标 < 5%

## 常见问题

### Q: 仍然出现超时错误怎么办？
A: 
1. 检查云函数配置是否生效
2. 查看云函数日志确认超时时间
3. 考虑进一步优化API调用参数

### Q: API调用失败怎么办？
A:
1. 检查DeepSeek API密钥是否有效
2. 确认API配额是否充足
3. 查看网络连接是否正常

### Q: 宠物回复不够个性化怎么办？
A:
1. 在数据库中添加更多宠物属性
2. 根据宠物品种、性格等优化prompt
3. 增加聊天历史上下文长度

---

**最后更新：** 2025年1月25日
**状态：** 已优化，等待测试验证