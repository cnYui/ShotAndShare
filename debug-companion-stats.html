<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™ªä¼´å¤©æ•°å’Œæ€»ç»éªŒå€¼è°ƒè¯•æŒ‡å—</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .step {
            background: #ecf0f1;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        ul {
            padding-left: 20px;
        }
        li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¾ é™ªä¼´å¤©æ•°å’Œæ€»ç»éªŒå€¼è°ƒè¯•æŒ‡å—</h1>
        
        <div class="warning">
            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>æœ¬è°ƒè¯•éœ€è¦åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­è¿›è¡Œï¼Œå› ä¸ºéœ€è¦è®¿é—®äº‘æ•°æ®åº“ã€‚
        </div>

        <h2>ğŸ” é—®é¢˜æ’æŸ¥æ­¥éª¤</h2>

        <div class="step">
            <h3>æ­¥éª¤1ï¼šæ£€æŸ¥äº‘å‡½æ•°éƒ¨ç½²çŠ¶æ€</h3>
            <p>åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š</p>
            <ul>
                <li>æ‰“å¼€äº‘å¼€å‘æ§åˆ¶å°</li>
                <li>è¿›å…¥äº‘å‡½æ•°æ ‡ç­¾é¡µ</li>
                <li>ç¡®è®¤ <code>petManager</code> äº‘å‡½æ•°å·²éƒ¨ç½²</li>
                <li>æ£€æŸ¥éƒ¨ç½²æ—¶é—´æ˜¯å¦æ˜¯æœ€æ–°çš„</li>
            </ul>
        </div>

        <div class="step">
            <h3>æ­¥éª¤2ï¼šåœ¨æ§åˆ¶å°ä¸­æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢</h3>
            <p>åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°ä¸­æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
            
            <div class="code">
// æ£€æŸ¥petsé›†åˆæ•°æ®
wx.cloud.database().collection('pets').get().then(res => {
  console.log('ğŸ¾ petsé›†åˆæ•°æ®:', res.data);
  res.data.forEach((pet, index) => {
    console.log(`å® ç‰© ${index + 1}:`, {
      user_id: pet.user_id,
      pet_name: pet.pet_name,
      created_at: pet.created_at,
      _createTime: pet._createTime,
      level: pet.level,
      exp: pet.exp
    });
    
    // è®¡ç®—é™ªä¼´å¤©æ•°
    const createTime = pet.created_at || pet._createTime;
    if (createTime) {
      const now = new Date();
      const created = new Date(createTime);
      const timeDiff = now.getTime() - created.getTime();
      const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
      console.log('è®¡ç®—çš„é™ªä¼´å¤©æ•°:', Math.max(daysDiff, 0));
    }
  });
}).catch(err => {
  console.error('âŒ æŸ¥è¯¢petså¤±è´¥:', err);
});
            </div>
        </div>

        <div class="step">
            <h3>æ­¥éª¤3ï¼šæ£€æŸ¥ä»»åŠ¡è®°å½•æ•°æ®</h3>
            <div class="code">
// æ£€æŸ¥task_recordsé›†åˆæ•°æ®
wx.cloud.database().collection('task_records').get().then(res => {
  console.log('ğŸ“‹ task_recordsé›†åˆæ•°æ®:', res.data);
  
  // ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„æ€»ç»éªŒå€¼
  const userStats = {};
  res.data.forEach(record => {
    const userId = record.user_id;
    if (!userStats[userId]) {
      userStats[userId] = { total: 0, completed: 0, totalExp: 0 };
    }
    
    userStats[userId].total++;
    if (record.status === 'completed') {
      userStats[userId].completed++;
      if (record.task_info && record.task_info.reward_exp) {
        userStats[userId].totalExp += record.task_info.reward_exp;
      }
    }
  });
  
  console.log('ğŸ“Š ç”¨æˆ·ä»»åŠ¡ç»Ÿè®¡:', userStats);
}).catch(err => {
  console.error('âŒ æŸ¥è¯¢task_recordså¤±è´¥:', err);
});
            </div>
        </div>

        <div class="step">
            <h3>æ­¥éª¤4ï¼šæµ‹è¯•äº‘å‡½æ•°è°ƒç”¨</h3>
            <div class="code">
// æµ‹è¯•getPetStatusäº‘å‡½æ•°
wx.cloud.callFunction({
  name: 'petManager',
  data: {
    action: 'getPetStatus'
  }
}).then(res => {
  console.log('âœ… getPetStatusç»“æœ:', res.result);
  if (res.result.success) {
    console.log('ğŸ” å…³é”®å­—æ®µæ£€æŸ¥:', {
      companionDays: res.result.data.companionDays,
      totalExp: res.result.data.totalExp,
      created_at: res.result.data.created_at,
      _createTime: res.result.data._createTime
    });
  }
}).catch(err => {
  console.error('âŒ äº‘å‡½æ•°è°ƒç”¨å¤±è´¥:', err);
});
            </div>
        </div>

        <h2>ğŸ”§ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</h2>

        <div class="error">
            <h3>é—®é¢˜1ï¼šé™ªä¼´å¤©æ•°æ˜¾ç¤ºä¸º0</h3>
            <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
            <ul>
                <li>å® ç‰©è®°å½•ç¼ºå°‘ <code>created_at</code> å­—æ®µ</li>
                <li>å­—æ®µå€¼ä¸º null æˆ–æ— æ•ˆæ—¥æœŸ</li>
            </ul>
            <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
            <div class="code">
// ä¿®å¤ç¼ºå°‘created_atå­—æ®µçš„å® ç‰©è®°å½•
wx.cloud.database().collection('pets').get().then(res => {
  res.data.forEach(pet => {
    if (!pet.created_at && pet._createTime) {
      // ä½¿ç”¨_createTimeä½œä¸ºcreated_at
      wx.cloud.database().collection('pets').doc(pet._id).update({
        data: {
          created_at: pet._createTime
        }
      }).then(() => {
        console.log('âœ… ä¿®å¤å® ç‰©', pet.pet_name, 'çš„created_atå­—æ®µ');
      });
    }
  });
});
            </div>
        </div>

        <div class="error">
            <h3>é—®é¢˜2ï¼šæ€»ç»éªŒå€¼æ˜¾ç¤ºä¸º0</h3>
            <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
            <ul>
                <li>task_recordsé›†åˆä¸­æ²¡æœ‰å·²å®Œæˆçš„ä»»åŠ¡</li>
                <li>ä»»åŠ¡è®°å½•ç¼ºå°‘ <code>task_info.reward_exp</code> å­—æ®µ</li>
            </ul>
            <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
            <div class="code">
// åˆ›å»ºæµ‹è¯•ä»»åŠ¡è®°å½•
wx.cloud.database().collection('task_records').add({
  data: {
    user_id: 'your_openid_here', // æ›¿æ¢ä¸ºå®é™…çš„openid
    task_id: 'test_task',
    status: 'completed',
    date: new Date().toISOString().split('T')[0],
    task_info: {
      name: 'æµ‹è¯•ä»»åŠ¡',
      reward_exp: 50
    },
    completed_at: new Date()
  }
}).then(res => {
  console.log('âœ… åˆ›å»ºæµ‹è¯•ä»»åŠ¡è®°å½•æˆåŠŸ:', res._id);
});
            </div>
        </div>

        <div class="success">
            <h3>âœ… éªŒè¯ä¿®å¤ç»“æœ</h3>
            <p>ä¿®å¤åï¼Œé‡æ–°åŠ è½½å® ç‰©ä¸»é¡µé¢ï¼Œæ£€æŸ¥ï¼š</p>
            <ul>
                <li>é™ªä¼´å¤©æ•°æ˜¯å¦æ­£ç¡®æ˜¾ç¤º</li>
                <li>æ€»ç»éªŒå€¼æ˜¯å¦æ­£ç¡®æ˜¾ç¤º</li>
                <li>æ§åˆ¶å°æ˜¯å¦æœ‰ç›¸å…³çš„è°ƒè¯•æ—¥å¿—</li>
            </ul>
        </div>

        <h2>ğŸ“ è°ƒè¯•æ—¥å¿—è¯´æ˜</h2>
        
        <div class="step">
            <p>åœ¨å® ç‰©ä¸»é¡µé¢ï¼ŒæŸ¥çœ‹æ§åˆ¶å°ä¸­çš„ä»¥ä¸‹æ—¥å¿—ï¼š</p>
            <ul>
                <li><code>ğŸ”„ å¼€å§‹åŠ è½½å® ç‰©æ•°æ®...</code> - æ•°æ®åŠ è½½å¼€å§‹</li>
                <li><code>âœ… è·å–å® ç‰©çŠ¶æ€æˆåŠŸ:</code> - äº‘å‡½æ•°è°ƒç”¨æˆåŠŸ</li>
                <li><code>ğŸ” æ£€æŸ¥è¿”å›æ•°æ®ä¸­çš„å…³é”®å­—æ®µ:</code> - å…³é”®å­—æ®µå€¼æ£€æŸ¥</li>
                <li><code>ğŸ“Š å® ç‰©æ•°æ®æ›´æ–°:</code> - å‰ç«¯æ•°æ®æ›´æ–°</li>
            </ul>
        </div>

        <div class="warning">
            <strong>ğŸ’¡ æç¤ºï¼š</strong>å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ï¼š
            <ul>
                <li>äº‘å‡½æ•°æ˜¯å¦å·²æ­£ç¡®éƒ¨ç½²</li>
                <li>æ•°æ®åº“æƒé™è®¾ç½®æ˜¯å¦æ­£ç¡®</li>
                <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
            </ul>
        </div>
    </div>
</body>
</html>