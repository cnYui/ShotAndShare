# 健康数据修复部署检查清单

## 🔧 修复内容总结

### 已修复的问题
- ✅ **重复数据问题**: 修复了 `upsertHealthData` 函数，确保每天只有一条记录
- ✅ **字段缺失问题**: 添加了 `water_ml`、`sleep_hours`、`exercise_minutes` 字段
- ✅ **数据覆盖问题**: 修复了更新逻辑，保留原有数据
- ✅ **超时问题**: 为所有云函数配置了合适的超时时间
- ✅ **前端兼容**: 更新了前端数据处理逻辑

## 📋 部署检查清单

### 第一阶段：云函数部署
- [ ] 1. 打开微信开发者工具
- [ ] 2. 确认 `cloudfunctions/healthDataManager/config.json` 包含超时配置
- [ ] 3. 右键 `healthDataManager` 文件夹 → 「上传并部署：云端安装依赖」
- [ ] 4. 等待部署完成，检查控制台无错误信息
- [ ] 5. 在云开发控制台验证云函数版本已更新

### 第二阶段：数据库清理
- [ ] 6. 在云开发控制台进入数据库管理
- [ ] 7. 备份 `health_data` 集合（导出数据）
- [ ] 8. 在云函数管理中测试 `healthDataManager`，参数：
  ```json
  {
    "action": "cleanAllDuplicates"
  }
  ```
- [ ] 9. 检查返回结果，确认清理成功
- [ ] 10. 验证数据库中每个用户每天只有一条记录

### 第三阶段：功能测试
- [ ] 11. 在小程序中进入健康数据页面
- [ ] 12. 测试编辑饮水量功能
- [ ] 13. 测试编辑睡眠时长功能
- [ ] 14. 测试编辑运动时长功能
- [ ] 15. 验证数据正确保存且不重复

### 第四阶段：数据验证
- [ ] 16. 在数据库中检查记录结构包含所有字段
- [ ] 17. 验证数据类型正确（数值字段为数字类型）
- [ ] 18. 确认时间戳字段正确更新
- [ ] 19. 检查前端显示数据正确

## 🧪 测试用例

### 测试用例 1：新用户首次录入
**步骤**:
1. 使用新用户登录小程序
2. 进入健康数据页面
3. 分别编辑饮水、睡眠、运动数据

**预期结果**:
- 数据库中创建一条新记录
- 包含所有字段且数值正确
- 前端显示更新的数据

### 测试用例 2：现有用户更新数据
**步骤**:
1. 使用已有数据的用户登录
2. 多次编辑同一天的健康数据
3. 检查数据库记录

**预期结果**:
- 数据库中该用户该日期只有一条记录
- 记录被更新而不是新增
- `updated_at` 字段正确更新

### 测试用例 3：跨天数据录入
**步骤**:
1. 在不同日期录入健康数据
2. 检查数据库记录

**预期结果**:
- 每天都有独立的记录
- 日期字段正确
- 数据不会相互覆盖

## 🚨 常见问题排查

### 问题 1：云函数部署失败
**可能原因**:
- 网络连接问题
- 代码语法错误
- 依赖包问题

**解决方案**:
1. 检查网络连接
2. 查看控制台错误信息
3. 重新安装依赖包

### 问题 2：数据仍然重复
**可能原因**:
- 云函数未正确部署
- 查询条件错误
- 并发写入问题

**解决方案**:
1. 确认云函数版本
2. 检查 `upsertHealthData` 函数逻辑
3. 添加数据库事务处理

### 问题 3：字段缺失
**可能原因**:
- 前端传参不完整
- 云函数字段映射错误
- 数据库写入逻辑问题

**解决方案**:
1. 检查前端传递的参数
2. 验证云函数字段处理
3. 确认数据库写入逻辑

### 问题 4：超时仍然发生
**可能原因**:
- 配置未生效
- 数据库查询性能问题
- 网络延迟

**解决方案**:
1. 重新部署云函数配置
2. 优化数据库查询
3. 增加超时时间

## 📊 监控指标

部署后需要监控以下指标：

### 数据质量指标
- 重复记录数量：应为 0
- 字段完整性：所有记录应包含必要字段
- 数据类型正确性：数值字段应为数字类型

### 性能指标
- 云函数执行时间：应在配置的超时时间内
- 数据库查询响应时间：应在合理范围内
- 错误率：应保持在低水平

### 用户体验指标
- 数据保存成功率：应接近 100%
- 页面加载时间：应在可接受范围内
- 用户反馈：关注用户对数据准确性的反馈

## 🎯 成功标准

部署成功的标准：
1. ✅ 数据库中无重复的健康数据记录
2. ✅ 所有健康数据记录包含完整字段
3. ✅ 云函数执行无超时错误
4. ✅ 前端正确显示所有健康数据
5. ✅ 用户可以正常编辑和保存数据
6. ✅ 数据更新而不是重复创建

## 📝 部署记录

请在完成每个步骤后记录：

- [ ] 部署时间：_____________
- [ ] 部署人员：_____________
- [ ] 云函数版本：_____________
- [ ] 清理的重复记录数：_____________
- [ ] 测试结果：_____________
- [ ] 遇到的问题：_____________
- [ ] 解决方案：_____________

---

**注意**: 建议在非高峰时段进行部署，并提前通知相关用户可能的短暂服务中断。