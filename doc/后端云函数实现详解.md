# 后端云函数实现详解

## 云函数架构概述

### 整体架构

```
cloudfunctions/
├── login/                   # 用户登录认证
├── userManager/             # 用户信息管理
├── petManager/              # 宠物信息管理
├── taskManager/             # 任务管理
├── healthDataManager/       # 健康数据管理
├── petChat/                 # AI聊天功能
├── analytics/               # 数据分析
├── initDatabase/            # 数据库初始化
└── logError/                # 错误日志记录
```

### 云函数通用结构

每个云函数都包含以下文件：
- `index.js` - 主要逻辑实现
- `package.json` - 依赖配置
- `config.json` - 云函数配置

## 核心云函数实现

### 1. 用户登录认证 (login)

#### 功能说明
- 处理微信用户登录
- 获取用户openid
- 创建或更新用户信息
- 返回用户数据

#### 实现代码

```javascript
// cloudfunctions/login/index.js
const cloud = require('wx-server-sdk');

// 初始化云开发环境
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();

/**
 * 用户登录云函数
 * @param {Object} event - 事件参数
 * @param {Object} event.userInfo - 用户信息
 * @returns {Object} 登录结果
 */
exports.main = async (event, context) => {
  console.log('登录请求:', event);
  
  try {
    // 获取微信调用上下文
    const wxContext = cloud.getWXContext();
    const openid = wxContext.OPENID;
    const appid = wxContext.APPID;
    const unionid = wxContext.UNIONID;
    
    if (!openid) {
      throw new Error('无法获取用户openid');
    }
    
    // 查询用户是否已存在
    const userQuery = await db.collection('users').where({
      openid: openid
    }).get();
    
    let userInfo;
    const currentTime = new Date();
    
    if (userQuery.data.length === 0) {
      // 新用户注册
      console.log('新用户注册:', openid);
      
      userInfo = {
        openid: openid,
        appid: appid,
        unionid: unionid,
        nickname: event.userInfo?.nickName || '新用户',
        avatar: event.userInfo?.avatarUrl || '',
        signature: '',
        level: 1,
        experience: 0,
        totalDays: 1,
        totalTasks: 0,
        settings: {
          theme: 'auto',
          language: 'zh-cn',
          notifications: {
            taskReminder: true,
            waterReminder: true,
            sleepReminder: true
          },
          privacy: {
            dataSync: true
          }
        },
        createTime: currentTime,
        updateTime: currentTime,
        lastLoginTime: currentTime
      };
      
      // 插入新用户
      const insertResult = await db.collection('users').add({
        data: userInfo
      });
      
      userInfo._id = insertResult._id;
      
      // 创建默认宠物
      await createDefaultPet(openid);
      
      // 创建初始任务
      await createInitialTasks(openid);
      
      return {
        success: true,
        isNewUser: true,
        userInfo: userInfo,
        message: '注册成功'
      };
      
    } else {
      // 老用户登录
      console.log('用户登录:', openid);
      
      userInfo = userQuery.data[0];
      
      // 更新用户信息
      const updateData = {
        lastLoginTime: currentTime,
        updateTime: currentTime
      };
      
      // 如果有新的用户信息，更新昵称和头像
      if (event.userInfo) {
        if (event.userInfo.nickName && event.userInfo.nickName !== userInfo.nickname) {
          updateData.nickname = event.userInfo.nickName;
        }
        if (event.userInfo.avatarUrl && event.userInfo.avatarUrl !== userInfo.avatar) {
          updateData.avatar = event.userInfo.avatarUrl;
        }
      }
      
      // 计算陪伴天数
      const daysDiff = calculateDaysDifference(userInfo.createTime, currentTime);
      if (daysDiff > userInfo.totalDays) {
        updateData.totalDays = daysDiff;
      }
      
      await db.collection('users').doc(userInfo._id).update({
        data: updateData
      });
      
      // 合并更新后的数据
      Object.assign(userInfo, updateData);
      
      return {
        success: true,
        isNewUser: false,
        userInfo: userInfo,
        message: '登录成功'
      };
    }
    
  } catch (error) {
    console.error('登录失败:', error);
    
    // 记录错误日志
    await logError('login', error, event);
    
    return {
      success: false,
      error: error.message,
      message: '登录失败，请重试'
    };
  }
};

/**
 * 创建默认宠物
 * @param {string} openid - 用户openid
 */
async function createDefaultPet(openid) {
  const petData = {
    userId: openid,
    name: '小绿',
    type: 'plant',
    level: 1,
    experience: 0,
    health: 80,
    happiness: 75,
    energy: 90,
    mood: 'happy',
    avatar: '/images/pet-default.png',
    createTime: new Date(),
    updateTime: new Date()
  };
  
  await db.collection('pets').add({
    data: petData
  });
}

/**
 * 创建初始任务
 * @param {string} openid - 用户openid
 */
async function createInitialTasks(openid) {
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  
  const initialTasks = [
    {
      userId: openid,
      title: '每日饮水',
      description: '今天喝足8杯水',
      type: 'daily',
      category: 'health',
      status: 'pending',
      progress: 0,
      target: 8,
      rewards: { exp: 20, coins: 10 },
      dueDate: tomorrow,
      createTime: today,
      updateTime: today
    },
    {
      userId: openid,
      title: '步行锻炼',
      description: '今天走路8000步',
      type: 'daily',
      category: 'exercise',
      status: 'pending',
      progress: 0,
      target: 8000,
      rewards: { exp: 30, coins: 15 },
      dueDate: tomorrow,
      createTime: today,
      updateTime: today
    }
  ];
  
  for (const task of initialTasks) {
    await db.collection('tasks').add({ data: task });
  }
}

/**
 * 计算天数差异
 * @param {Date} startDate - 开始日期
 * @param {Date} endDate - 结束日期
 * @returns {number} 天数差异
 */
function calculateDaysDifference(startDate, endDate) {
  const timeDiff = endDate.getTime() - startDate.getTime();
  return Math.ceil(timeDiff / (1000 * 3600 * 24));
}

/**
 * 记录错误日志
 * @param {string} functionName - 函数名
 * @param {Error} error - 错误对象
 * @param {Object} event - 事件参数
 */
async function logError(functionName, error, event) {
  try {
    await db.collection('errorLogs').add({
      data: {
        functionName,
        error: {
          message: error.message,
          stack: error.stack
        },
        event,
        timestamp: new Date()
      }
    });
  } catch (logErr) {
    console.error('记录错误日志失败:', logErr);
  }
}
```

#### 配置文件

```json
// cloudfunctions/login/config.json
{
  "permissions": {
    "openapi": []
  },
  "timeout": 10,
  "envVariables": {},
  "runtime": "Nodejs16.13"
}
```

```json
// cloudfunctions/login/package.json
{
  "name": "login",
  "version": "1.0.0",
  "description": "用户登录云函数",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "~2.6.3"
  }
}
```

### 2. 用户信息管理 (userManager)

#### 功能说明
- 获取用户信息
- 更新用户资料
- 管理用户设置
- 用户数据统计

#### 实现代码

```javascript
// cloudfunctions/userManager/index.js
const cloud = require('wx-server-sdk');

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();
const _ = db.command;

exports.main = async (event, context) => {
  console.log('用户管理请求:', event);
  
  try {
    const wxContext = cloud.getWXContext();
    const openid = wxContext.OPENID;
    
    if (!openid) {
      throw new Error('用户未登录');
    }
    
    const { action } = event;
    
    switch (action) {
      case 'get':
        return await getUserInfo(openid);
      case 'update':
        return await updateUserInfo(openid, event.data);
      case 'updateSettings':
        return await updateUserSettings(openid, event.settings);
      case 'getStats':
        return await getUserStats(openid);
      case 'updateAvatar':
        return await updateUserAvatar(openid, event.avatarUrl);
      default:
        throw new Error('无效的操作类型');
    }
    
  } catch (error) {
    console.error('用户管理失败:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * 获取用户信息
 * @param {string} openid - 用户openid
 */
async function getUserInfo(openid) {
  const result = await db.collection('users').where({
    openid: openid
  }).get();
  
  if (result.data.length === 0) {
    throw new Error('用户不存在');
  }
  
  return {
    success: true,
    userInfo: result.data[0]
  };
}

/**
 * 更新用户信息
 * @param {string} openid - 用户openid
 * @param {Object} data - 更新数据
 */
async function updateUserInfo(openid, data) {
  const updateData = {
    updateTime: new Date()
  };
  
  // 允许更新的字段
  const allowedFields = ['nickname', 'signature'];
  
  allowedFields.forEach(field => {
    if (data[field] !== undefined) {
      updateData[field] = data[field];
    }
  });
  
  await db.collection('users').where({
    openid: openid
  }).update({
    data: updateData
  });
  
  return {
    success: true,
    message: '用户信息更新成功'
  };
}

/**
 * 更新用户设置
 * @param {string} openid - 用户openid
 * @param {Object} settings - 设置数据
 */
async function updateUserSettings(openid, settings) {
  await db.collection('users').where({
    openid: openid
  }).update({
    data: {
      settings: settings,
      updateTime: new Date()
    }
  });
  
  return {
    success: true,
    message: '设置更新成功'
  };
}

/**
 * 获取用户统计数据
 * @param {string} openid - 用户openid
 */
async function getUserStats(openid) {
  // 获取用户基本信息
  const userResult = await db.collection('users').where({
    openid: openid
  }).get();
  
  if (userResult.data.length === 0) {
    throw new Error('用户不存在');
  }
  
  const user = userResult.data[0];
  
  // 获取任务统计
  const taskStats = await getTaskStats(openid);
  
  // 获取健康数据统计
  const healthStats = await getHealthStats(openid);
  
  return {
    success: true,
    stats: {
      user: {
        level: user.level,
        experience: user.experience,
        totalDays: user.totalDays,
        totalTasks: user.totalTasks
      },
      tasks: taskStats,
      health: healthStats
    }
  };
}

/**
 * 获取任务统计
 * @param {string} openid - 用户openid
 */
async function getTaskStats(openid) {
  const tasks = await db.collection('tasks').where({
    userId: openid
  }).get();
  
  const stats = {
    total: tasks.data.length,
    completed: 0,
    pending: 0,
    inProgress: 0
  };
  
  tasks.data.forEach(task => {
    stats[task.status]++;
  });
  
  return stats;
}

/**
 * 获取健康数据统计
 * @param {string} openid - 用户openid
 */
async function getHealthStats(openid) {
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  // 获取今日数据
  const todayData = await db.collection('healthData').where({
    userId: openid,
    date: todayStr
  }).get();
  
  // 获取本周数据
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay());
  const weekStartStr = weekStart.toISOString().split('T')[0];
  
  const weekData = await db.collection('healthData').where({
    userId: openid,
    date: _.gte(weekStartStr)
  }).get();
  
  return {
    today: todayData.data[0] || { steps: 0, water: 0, sleep: 0, exercise: 0 },
    week: calculateWeekStats(weekData.data)
  };
}

/**
 * 计算周统计数据
 * @param {Array} weekData - 周数据
 */
function calculateWeekStats(weekData) {
  const stats = {
    totalSteps: 0,
    totalWater: 0,
    totalSleep: 0,
    totalExercise: 0,
    avgSteps: 0,
    avgWater: 0,
    avgSleep: 0,
    avgExercise: 0
  };
  
  if (weekData.length === 0) {
    return stats;
  }
  
  weekData.forEach(day => {
    stats.totalSteps += day.steps || 0;
    stats.totalWater += day.water || 0;
    stats.totalSleep += day.sleep || 0;
    stats.totalExercise += day.exercise || 0;
  });
  
  const days = weekData.length;
  stats.avgSteps = Math.round(stats.totalSteps / days);
  stats.avgWater = Math.round(stats.totalWater / days);
  stats.avgSleep = Math.round(stats.totalSleep / days * 10) / 10;
  stats.avgExercise = Math.round(stats.totalExercise / days);
  
  return stats;
}

/**
 * 更新用户头像
 * @param {string} openid - 用户openid
 * @param {string} avatarUrl - 头像URL
 */
async function updateUserAvatar(openid, avatarUrl) {
  await db.collection('users').where({
    openid: openid
  }).update({
    data: {
      avatar: avatarUrl,
      updateTime: new Date()
    }
  });
  
  return {
    success: true,
    message: '头像更新成功'
  };
}
```

### 3. 宠物管理 (petManager)

#### 功能说明
- 获取宠物信息
- 宠物互动处理
- 宠物状态更新
- 宠物升级逻辑

#### 实现代码

```javascript
// cloudfunctions/petManager/index.js
const cloud = require('wx-server-sdk');

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();
const _ = db.command;

exports.main = async (event, context) => {
  console.log('宠物管理请求:', event);
  
  try {
    const wxContext = cloud.getWXContext();
    const openid = wxContext.OPENID;
    
    if (!openid) {
      throw new Error('用户未登录');
    }
    
    const { action } = event;
    
    switch (action) {
      case 'get':
        return await getPetInfo(openid);
      case 'interact':
        return await handlePetInteraction(openid, event.interactionType, event.effects);
      case 'update':
        return await updatePetInfo(openid, event.data);
      case 'feed':
        return await feedPet(openid);
      case 'play':
        return await playWithPet(openid);
      case 'exercise':
        return await exerciseWithPet(openid);
      case 'rest':
        return await restWithPet(openid);
      default:
        throw new Error('无效的操作类型');
    }
    
  } catch (error) {
    console.error('宠物管理失败:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * 获取宠物信息
 * @param {string} openid - 用户openid
 */
async function getPetInfo(openid) {
  const result = await db.collection('pets').where({
    userId: openid
  }).get();
  
  if (result.data.length === 0) {
    // 如果没有宠物，创建默认宠物
    const defaultPet = await createDefaultPet(openid);
    return {
      success: true,
      petInfo: defaultPet
    };
  }
  
  const pet = result.data[0];
  
  // 更新宠物心情
  const mood = calculatePetMood(pet.health, pet.happiness, pet.energy);
  if (mood !== pet.mood) {
    await updatePetMood(pet._id, mood);
    pet.mood = mood;
  }
  
  return {
    success: true,
    petInfo: pet
  };
}

/**
 * 处理宠物互动
 * @param {string} openid - 用户openid
 * @param {string} interactionType - 互动类型
 * @param {Object} effects - 效果
 */
async function handlePetInteraction(openid, interactionType, effects) {
  const petResult = await db.collection('pets').where({
    userId: openid
  }).get();
  
  if (petResult.data.length === 0) {
    throw new Error('宠物不存在');
  }
  
  const pet = petResult.data[0];
  const updateData = {
    updateTime: new Date()
  };
  
  // 应用效果
  if (effects.health) {
    updateData.health = Math.max(0, Math.min(100, pet.health + effects.health));
  }
  if (effects.happiness) {
    updateData.happiness = Math.max(0, Math.min(100, pet.happiness + effects.happiness));
  }
  if (effects.energy) {
    updateData.energy = Math.max(0, Math.min(100, pet.energy + effects.energy));
  }
  if (effects.experience) {
    updateData.experience = pet.experience + effects.experience;
    
    // 检查是否升级
    const newLevel = calculateLevel(updateData.experience);
    if (newLevel > pet.level) {
      updateData.level = newLevel;
    }
  }
  
  // 更新心情
  updateData.mood = calculatePetMood(
    updateData.health || pet.health,
    updateData.happiness || pet.happiness,
    updateData.energy || pet.energy
  );
  
  // 更新数据库
  await db.collection('pets').doc(pet._id).update({
    data: updateData
  });
  
  // 更新用户经验
  if (effects.experience) {
    await updateUserExperience(openid, effects.experience);
  }
  
  // 合并更新后的宠物信息
  const updatedPet = { ...pet, ...updateData };
  
  return {
    success: true,
    petInfo: updatedPet,
    rewards: {
      exp: effects.experience || 0
    },
    message: `${interactionType}成功！`
  };
}

/**
 * 喂食宠物
 * @param {string} openid - 用户openid
 */
async function feedPet(openid) {
  return await handlePetInteraction(openid, 'feed', {
    health: 5,
    happiness: 3,
    experience: 10
  });
}

/**
 * 和宠物玩耍
 * @param {string} openid - 用户openid
 */
async function playWithPet(openid) {
  return await handlePetInteraction(openid, 'play', {
    happiness: 8,
    energy: -5,
    experience: 15
  });
}

/**
 * 和宠物运动
 * @param {string} openid - 用户openid
 */
async function exerciseWithPet(openid) {
  return await handlePetInteraction(openid, 'exercise', {
    health: 8,
    energy: -10,
    experience: 20
  });
}

/**
 * 宠物休息
 * @param {string} openid - 用户openid
 */
async function restWithPet(openid) {
  return await handlePetInteraction(openid, 'rest', {
    energy: 15,
    experience: 5
  });
}

/**
 * 创建默认宠物
 * @param {string} openid - 用户openid
 */
async function createDefaultPet(openid) {
  const petData = {
    userId: openid,
    name: '小绿',
    type: 'plant',
    level: 1,
    experience: 0,
    health: 80,
    happiness: 75,
    energy: 90,
    mood: 'happy',
    avatar: '/images/pet-default.png',
    createTime: new Date(),
    updateTime: new Date()
  };
  
  const result = await db.collection('pets').add({
    data: petData
  });
  
  petData._id = result._id;
  return petData;
}

/**
 * 计算宠物心情
 * @param {number} health - 健康值
 * @param {number} happiness - 快乐值
 * @param {number} energy - 活力值
 */
function calculatePetMood(health, happiness, energy) {
  const average = (health + happiness + energy) / 3;
  
  if (average >= 80) return 'veryHappy';
  if (average >= 60) return 'happy';
  if (average >= 40) return 'normal';
  return 'needCare';
}

/**
 * 计算等级
 * @param {number} experience - 经验值
 */
function calculateLevel(experience) {
  return Math.floor(experience / 100) + 1;
}

/**
 * 更新宠物心情
 * @param {string} petId - 宠物ID
 * @param {string} mood - 心情
 */
async function updatePetMood(petId, mood) {
  await db.collection('pets').doc(petId).update({
    data: {
      mood: mood,
      updateTime: new Date()
    }
  });
}

/**
 * 更新用户经验
 * @param {string} openid - 用户openid
 * @param {number} exp - 经验值
 */
async function updateUserExperience(openid, exp) {
  const userResult = await db.collection('users').where({
    openid: openid
  }).get();
  
  if (userResult.data.length > 0) {
    const user = userResult.data[0];
    const newExp = user.experience + exp;
    const newLevel = calculateLevel(newExp);
    
    await db.collection('users').doc(user._id).update({
      data: {
        experience: newExp,
        level: newLevel,
        updateTime: new Date()
      }
    });
  }
}
```

### 4. 任务管理 (taskManager)

#### 功能说明
- 获取任务列表
- 创建新任务
- 更新任务进度
- 完成任务处理
- 任务奖励发放

#### 实现代码

```javascript
// cloudfunctions/taskManager/index.js
const cloud = require('wx-server-sdk');

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();
const _ = db.command;

exports.main = async (event, context) => {
  console.log('任务管理请求:', event);
  
  try {
    const wxContext = cloud.getWXContext();
    const openid = wxContext.OPENID;
    
    if (!openid) {
      throw new Error('用户未登录');
    }
    
    const { action } = event;
    
    switch (action) {
      case 'list':
        return await getTaskList(openid, event.filter);
      case 'create':
        return await createTask(openid, event.taskData);
      case 'update':
        return await updateTaskProgress(openid, event.taskId, event.progress);
      case 'complete':
        return await completeTask(openid, event.taskId);
      case 'delete':
        return await deleteTask(openid, event.taskId);
      case 'generateDaily':
        return await generateDailyTasks(openid);
      case 'getStats':
        return await getTaskStats(openid);
      default:
        throw new Error('无效的操作类型');
    }
    
  } catch (error) {
    console.error('任务管理失败:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * 获取任务列表
 * @param {string} openid - 用户openid
 * @param {Object} filter - 过滤条件
 */
async function getTaskList(openid, filter = {}) {
  const query = {
    userId: openid
  };
  
  // 应用过滤条件
  if (filter.type) {
    query.type = filter.type;
  }
  if (filter.status) {
    query.status = filter.status;
  }
  if (filter.category) {
    query.category = filter.category;
  }
  
  const result = await db.collection('tasks')
    .where(query)
    .orderBy('createTime', 'desc')
    .get();
  
  // 按类型分组
  const groupedTasks = {
    daily: [],
    weekly: [],
    special: []
  };
  
  result.data.forEach(task => {
    if (groupedTasks[task.type]) {
      groupedTasks[task.type].push(task);
    }
  });
  
  return {
    success: true,
    tasks: result.data,
    groupedTasks: groupedTasks,
    total: result.data.length
  };
}

/**
 * 创建任务
 * @param {string} openid - 用户openid
 * @param {Object} taskData - 任务数据
 */
async function createTask(openid, taskData) {
  const task = {
    userId: openid,
    title: taskData.title,
    description: taskData.description || '',
    type: taskData.type || 'daily',
    category: taskData.category || 'general',
    status: 'pending',
    progress: 0,
    target: taskData.target || 1,
    rewards: taskData.rewards || { exp: 10, coins: 5 },
    dueDate: taskData.dueDate || getDefaultDueDate(taskData.type),
    createTime: new Date(),
    updateTime: new Date()
  };
  
  const result = await db.collection('tasks').add({
    data: task
  });
  
  task._id = result._id;
  
  return {
    success: true,
    task: task,
    message: '任务创建成功'
  };
}

/**
 * 更新任务进度
 * @param {string} openid - 用户openid
 * @param {string} taskId - 任务ID
 * @param {number} progress - 进度
 */
async function updateTaskProgress(openid, taskId, progress) {
  const taskResult = await db.collection('tasks').doc(taskId).get();
  
  if (!taskResult.data || taskResult.data.userId !== openid) {
    throw new Error('任务不存在或无权限');
  }
  
  const task = taskResult.data;
  const newProgress = Math.min(progress, task.target);
  const status = newProgress >= task.target ? 'completed' : 'inProgress';
  
  await db.collection('tasks').doc(taskId).update({
    data: {
      progress: newProgress,
      status: status,
      updateTime: new Date(),
      ...(status === 'completed' ? { completedAt: new Date() } : {})
    }
  });
  
  // 如果任务完成，发放奖励
  if (status === 'completed' && task.status !== 'completed') {
    await grantTaskRewards(openid, task.rewards);
    
    return {
      success: true,
      completed: true,
      rewards: task.rewards,
      message: '任务完成！'
    };
  }
  
  return {
    success: true,
    completed: false,
    progress: newProgress,
    message: '进度更新成功'
  };
}

/**
 * 完成任务
 * @param {string} openid - 用户openid
 * @param {string} taskId - 任务ID
 */
async function completeTask(openid, taskId) {
  const taskResult = await db.collection('tasks').doc(taskId).get();
  
  if (!taskResult.data || taskResult.data.userId !== openid) {
    throw new Error('任务不存在或无权限');
  }
  
  const task = taskResult.data;
  
  if (task.status === 'completed') {
    throw new Error('任务已完成');
  }
  
  // 更新任务状态
  await db.collection('tasks').doc(taskId).update({
    data: {
      status: 'completed',
      progress: task.target,
      completedAt: new Date(),
      updateTime: new Date()
    }
  });
  
  // 发放奖励
  await grantTaskRewards(openid, task.rewards);
  
  // 更新用户任务完成数
  await updateUserTaskCount(openid);
  
  return {
    success: true,
    rewards: task.rewards,
    message: '任务完成！'
  };
}

/**
 * 生成每日任务
 * @param {string} openid - 用户openid
 */
async function generateDailyTasks(openid) {
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  // 检查今天是否已生成任务
  const existingTasks = await db.collection('tasks').where({
    userId: openid,
    type: 'daily',
    createTime: _.gte(new Date(todayStr))
  }).get();
  
  if (existingTasks.data.length > 0) {
    return {
      success: true,
      message: '今日任务已存在',
      tasks: existingTasks.data
    };
  }
  
  // 生成新的每日任务
  const dailyTasks = [
    {
      title: '每日饮水',
      description: '今天喝足8杯水',
      category: 'health',
      target: 8,
      rewards: { exp: 20, coins: 10 }
    },
    {
      title: '步行锻炼',
      description: '今天走路8000步',
      category: 'exercise',
      target: 8000,
      rewards: { exp: 30, coins: 15 }
    },
    {
      title: '充足睡眠',
      description: '睡眠时间达到8小时',
      category: 'sleep',
      target: 8,
      rewards: { exp: 25, coins: 12 }
    }
  ];
  
  const createdTasks = [];
  
  for (const taskTemplate of dailyTasks) {
    const task = {
      userId: openid,
      ...taskTemplate,
      type: 'daily',
      status: 'pending',
      progress: 0,
      dueDate: getDefaultDueDate('daily'),
      createTime: today,
      updateTime: today
    };
    
    const result = await db.collection('tasks').add({ data: task });
    task._id = result._id;
    createdTasks.push(task);
  }
  
  return {
    success: true,
    tasks: createdTasks,
    message: '每日任务生成成功'
  };
}

/**
 * 获取任务统计
 * @param {string} openid - 用户openid
 */
async function getTaskStats(openid) {
  const tasks = await db.collection('tasks').where({
    userId: openid
  }).get();
  
  const stats = {
    total: tasks.data.length,
    completed: 0,
    pending: 0,
    inProgress: 0,
    byType: {
      daily: { total: 0, completed: 0 },
      weekly: { total: 0, completed: 0 },
      special: { total: 0, completed: 0 }
    },
    byCategory: {}
  };
  
  tasks.data.forEach(task => {
    // 状态统计
    stats[task.status]++;
    
    // 类型统计
    if (stats.byType[task.type]) {
      stats.byType[task.type].total++;
      if (task.status === 'completed') {
        stats.byType[task.type].completed++;
      }
    }
    
    // 分类统计
    if (!stats.byCategory[task.category]) {
      stats.byCategory[task.category] = { total: 0, completed: 0 };
    }
    stats.byCategory[task.category].total++;
    if (task.status === 'completed') {
      stats.byCategory[task.category].completed++;
    }
  });
  
  return {
    success: true,
    stats: stats
  };
}

/**
 * 发放任务奖励
 * @param {string} openid - 用户openid
 * @param {Object} rewards - 奖励
 */
async function grantTaskRewards(openid, rewards) {
  if (rewards.exp) {
    await updateUserExperience(openid, rewards.exp);
  }
  
  // 这里可以添加金币等其他奖励的处理逻辑
}

/**
 * 更新用户经验
 * @param {string} openid - 用户openid
 * @param {number} exp - 经验值
 */
async function updateUserExperience(openid, exp) {
  const userResult = await db.collection('users').where({
    openid: openid
  }).get();
  
  if (userResult.data.length > 0) {
    const user = userResult.data[0];
    const newExp = user.experience + exp;
    const newLevel = Math.floor(newExp / 100) + 1;
    
    await db.collection('users').doc(user._id).update({
      data: {
        experience: newExp,
        level: newLevel,
        updateTime: new Date()
      }
    });
  }
}

/**
 * 更新用户任务完成数
 * @param {string} openid - 用户openid
 */
async function updateUserTaskCount(openid) {
  await db.collection('users').where({
    openid: openid
  }).update({
    data: {
      totalTasks: _.inc(1),
      updateTime: new Date()
    }
  });
}

/**
 * 获取默认截止日期
 * @param {string} type - 任务类型
 */
function getDefaultDueDate(type) {
  const now = new Date();
  
  switch (type) {
    case 'daily':
      const tomorrow = new Date(now);
      tomorrow.setDate(now.getDate() + 1);
      tomorrow.setHours(23, 59, 59, 999);
      return tomorrow;
    case 'weekly':
      const nextWeek = new Date(now);
      nextWeek.setDate(now.getDate() + 7);
      return nextWeek;
    default:
      const nextMonth = new Date(now);
      nextMonth.setMonth(now.getMonth() + 1);
      return nextMonth;
  }
}
```

### 5. 健康数据管理 (healthDataManager)

#### 功能说明
- 记录健康数据
- 获取数据统计
- 数据分析和建议
- 微信运动数据解密

#### 实现代码

```javascript
// cloudfunctions/healthDataManager/index.js
const cloud = require('wx-server-sdk');

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
});

const db = cloud.database();
const _ = db.command;

exports.main = async (event, context) => {
  console.log('健康数据管理请求:', event);
  
  try {
    const wxContext = cloud.getWXContext();
    const openid = wxContext.OPENID;
    
    if (!openid) {
      throw new Error('用户未登录');
    }
    
    const { action } = event;
    
    switch (action) {
      case 'getTodayData':
        return await getTodayData(openid);
      case 'updateData':
        return await updateHealthData(openid, event.date, event.data);
      case 'getWeekData':
        return await getWeekData(openid);
      case 'getMonthData':
        return await getMonthData(openid);
      case 'addWater':
        return await addWaterIntake(openid, event.amount);
      case 'getInsights':
        return await getHealthInsights(openid);
      case 'syncWeRunData':
        return await syncWeRunData(openid, event.stepData);
      default:
        throw new Error('无效的操作类型');
    }
    
  } catch (error) {
    console.error('健康数据管理失败:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

/**
 * 获取今日数据
 * @param {string} openid - 用户openid
 */
async function getTodayData(openid) {
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  const result = await db.collection('healthData').where({
    userId: openid,
    date: todayStr
  }).get();
  
  let todayData;
  
  if (result.data.length === 0) {
    // 创建今日数据记录
    todayData = {
      userId: openid,
      date: todayStr,
      steps: 0,
      water: 0,
      sleep: 0,
      exercise: 0,
      createTime: today,
      updateTime: today
    };
    
    const insertResult = await db.collection('healthData').add({
      data: todayData
    });
    
    todayData._id = insertResult._id;
  } else {
    todayData = result.data[0];
  }
  
  return {
    success: true,
    data: todayData
  };
}

/**
 * 更新健康数据
 * @param {string} openid - 用户openid
 * @param {string} date - 日期
 * @param {Object} data - 数据
 */
async function updateHealthData(openid, date, data) {
  const updateData = {
    updateTime: new Date()
  };
  
  // 允许更新的字段
  const allowedFields = ['steps', 'water', 'sleep', 'exercise'];
  
  allowedFields.forEach(field => {
    if (data[field] !== undefined) {
      updateData[field] = Math.max(0, data[field]);
    }
  });
  
  // 查找现有记录
  const existing = await db.collection('healthData').where({
    userId: openid,
    date: date
  }).get();
  
  if (existing.data.length === 0) {
    // 创建新记录
    const newData = {
      userId: openid,
      date: date,
      steps: 0,
      water: 0,
      sleep: 0,
      exercise: 0,
      ...updateData,
      createTime: new Date()
    };
    
    await db.collection('healthData').add({ data: newData });
  } else {
    // 更新现有记录
    await db.collection('healthData').doc(existing.data[0]._id).update({
      data: updateData
    });
  }
  
  return {
    success: true,
    message: '数据更新成功'
  };
}

/**
 * 获取本周数据
 * @param {string} openid - 用户openid
 */
async function getWeekData(openid) {
  const today = new Date();
  const weekStart = new Date(today);
  weekStart.setDate(today.getDate() - today.getDay());
  const weekStartStr = weekStart.toISOString().split('T')[0];
  
  const result = await db.collection('healthData').where({
    userId: openid,
    date: _.gte(weekStartStr)
  }).orderBy('date', 'asc').get();
  
  // 填充缺失的日期
  const weekData = [];
  for (let i = 0; i < 7; i++) {
    const date = new Date(weekStart);
    date.setDate(weekStart.getDate() + i);
    const dateStr = date.toISOString().split('T')[0];
    
    const dayData = result.data.find(d => d.date === dateStr) || {
      date: dateStr,
      steps: 0,
      water: 0,
      sleep: 0,
      exercise: 0
    };
    
    weekData.push(dayData);
  }
  
  return {
    success: true,
    data: weekData,
    stats: calculateWeekStats(weekData)
  };
}

/**
 * 获取本月数据
 * @param {string} openid - 用户openid
 */
async function getMonthData(openid) {
  const today = new Date();
  const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
  const monthStartStr = monthStart.toISOString().split('T')[0];
  
  const result = await db.collection('healthData').where({
    userId: openid,
    date: _.gte(monthStartStr)
  }).orderBy('date', 'asc').get();
  
  return {
    success: true,
    data: result.data,
    stats: calculateMonthStats(result.data)
  };
}

/**
 * 添加饮水记录
 * @param {string} openid - 用户openid
 * @param {number} amount - 饮水量
 */
async function addWaterIntake(openid, amount) {
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  
  const existing = await db.collection('healthData').where({
    userId: openid,
    date: todayStr
  }).get();
  
  if (existing.data.length === 0) {
    // 创建新记录
    await db.collection('healthData').add({
      data: {
        userId: openid,
        date: todayStr,
        steps: 0,
        water: amount,
        sleep: 0,
        exercise: 0,
        createTime: today,
        updateTime: today
      }
    });
  } else {
    // 更新现有记录
    await db.collection('healthData').doc(existing.data[0]._id).update({
      data: {
        water: _.inc(amount),
        updateTime: today
      }
    });
  }
  
  return {
    success: true,
    message: '饮水记录添加成功'
  };
}

/**
 * 获取健康建议
 * @param {string} openid - 用户openid
 */
async function getHealthInsights(openid) {
  const todayData = await getTodayData(openid);
  const weekData = await getWeekData(openid);
  
  const insights = [];
  const data = todayData.data;
  
  // 步数建议
  if (data.steps >= 8000) {
    insights.push({
      type: 'steps',
      level: 'good',
      message: '今日步数达标，继续保持！'
    });
  } else {
    insights.push({
      type: 'steps',
      level: 'warning',
      message: '今日步数偏少，建议多走动'
    });
  }
  
  // 饮水建议
  if (data.water >= 2000) {
    insights.push({
      type: 'water',
      level: 'good',
      message: '饮水量充足，很棒！'
    });
  } else {
    insights.push({
      type: 'water',
      level: 'warning',
      message: '饮水量不足，记得多喝水'
    });
  }
  
  // 睡眠建议
  if (data.sleep >= 7) {
    insights.push({
      type: 'sleep',
      level: 'good',
      message: '睡眠时间充足'
    });
  } else if (data.sleep > 0) {
    insights.push({
      type: 'sleep',
      level: 'warning',
      message: '睡眠不足，注意休息'
    });
  }
  
  return {
    success: true,
    insights: insights,
    weekTrend: weekData.stats
  };
}

/**
 * 同步微信运动数据
 * @param {string} openid - 用户openid
 * @param {Array} stepData - 步数数据
 */
async function syncWeRunData(openid, stepData) {
  const updates = [];
  
  for (const dayData of stepData) {
    const date = new Date(dayData.timestamp * 1000);
    const dateStr = date.toISOString().split('T')[0];
    
    const existing = await db.collection('healthData').where({
      userId: openid,
      date: dateStr
    }).get();
    
    if (existing.data.length === 0) {
      // 创建新记录
      await db.collection('healthData').add({
        data: {
          userId: openid,
          date: dateStr,
          steps: dayData.step,
          water: 0,
          sleep: 0,
          exercise: 0,
          createTime: new Date(),
          updateTime: new Date()
        }
      });
    } else {
      // 更新步数
      await db.collection('healthData').doc(existing.data[0]._id).update({
        data: {
          steps: dayData.step,
          updateTime: new Date()
        }
      });
    }
    
    updates.push({
      date: dateStr,
      steps: dayData.step
    });
  }
  
  return {
    success: true,
    updates: updates,
    message: '微信运动数据同步成功'
  };
}

/**
 * 计算周统计
 * @param {Array} weekData - 周数据
 */
function calculateWeekStats(weekData) {
  const stats = {
    totalSteps: 0,
    totalWater: 0,
    totalSleep: 0,
    totalExercise: 0,
    avgSteps: 0,
    avgWater: 0,
    avgSleep: 0,
    avgExercise: 0
  };
  
  if (weekData.length === 0) return stats;
  
  weekData.forEach(day => {
    stats.totalSteps += day.steps || 0;
    stats.totalWater += day.water || 0;
    stats.totalSleep += day.sleep || 0;
    stats.totalExercise += day.exercise || 0;
  });
  
  const days = weekData.length;
  stats.avgSteps = Math.round(stats.totalSteps / days);
  stats.avgWater = Math.round(stats.totalWater / days);
  stats.avgSleep = Math.round(stats.totalSleep / days * 10) / 10;
  stats.avgExercise = Math.round(stats.totalExercise / days);
  
  return stats;
}

/**
 * 计算月统计
 * @param {Array} monthData - 月数据
 */
function calculateMonthStats(monthData) {
  const stats = calculateWeekStats(monthData);
  
  // 添加月度特有统计
  stats.activeDays = monthData.filter(day => 
    day.steps > 0 || day.water > 0 || day.sleep > 0 || day.exercise > 0
  ).length;
  
  return stats;
}
```

## 云函数部署和配置

### 1. 部署脚本

```bash
#!/bin/bash
# deploy-functions.sh

echo "开始部署云函数..."

# 部署所有云函数
functions=("login" "userManager" "petManager" "taskManager" "healthDataManager" "petChat" "analytics" "initDatabase" "logError")

for func in "${functions[@]}"; do
  echo "部署 $func..."
  cd cloudfunctions/$func
  npm install
  cd ../..
  npx tcb fn deploy $func
done

echo "云函数部署完成！"
```

### 2. 环境变量配置

```javascript
// 环境变量示例
const config = {
  development: {
    env: 'dev-env-id',
    database: 'dev-database'
  },
  production: {
    env: 'prod-env-id',
    database: 'prod-database'
  }
};
```

### 3. 数据库权限配置

```json
{
  "read": "auth != null",
  "write": "auth != null && auth.openid == resource.userId",
  "create": "auth != null",
  "delete": "auth != null && auth.openid == resource.userId"
}
```

## 总结

后端云函数架构的核心特点：

1. **模块化设计**：每个云函数负责特定的业务逻辑
2. **统一错误处理**：标准化的错误处理和日志记录
3. **数据安全**：基于openid的用户权限控制
4. **性能优化**：合理的数据库查询和缓存策略
5. **可扩展性**：易于添加新功能和修改现有逻辑
6. **监控和日志**：完整的错误日志和性能监控

这个云函数架构为小程序提供了稳定、安全、高效的后端服务支持。