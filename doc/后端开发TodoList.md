# 健康养宠小程序后端开发 Todo List

## 数据库设计与实现

### 1. 数据库表结构设计
- [x] 设计用户表（pet_users）结构
  - [x] user_id（主键，使用微信openid）
  - [x] nickname（昵称）
  - [x] avatar_url（头像URL）
  - [x] gender（性别，可选）
  - [x] city（城市，可选）
  - [x] join_date（注册日期）
  - [x] 添加索引优化查询性能

- [x] 设计宠物表（Pet）结构
  - [x] pet_id（主键）
  - [x] user_id（外键，关联User表）
  - [x] pet_name（宠物名字）
  - [x] species（宠物类型）
  - [x] level（等级）
  - [x] exp（当前经验值）
  - [x] health（健康值）
  - [x] vitality（活力值）
  - [x] intimacy（亲密度）
  - [x] last_active（最后互动时间）
  - [x] 设置外键约束和级联删除

- [x] 设计任务定义表（Task）结构
  - [x] task_id（主键）
  - [x] name（任务名称）
  - [x] category（类别）
  - [x] target_value（目标值）
  - [x] unit（单位）
  - [x] reward_exp（经验奖励）
  - [x] reward_item（其他奖励）
  - [x] is_active（是否启用）

- [x] 设计每日任务记录表（TaskRecord）结构
  - [x] record_id（主键）
  - [x] user_id（用户ID）
  - [x] date（日期）
  - [x] task_id（任务ID）
  - [x] status（完成状态）
  - [x] progress（当前进度）
  - [x] completed_at（完成时间）
  - [x] 创建复合索引（user_id, date）

- [x] 设计健康数据表（HealthData）结构
  - [x] data_id（主键）
  - [x] user_id（用户ID）
  - [x] date（日期）
  - [x] steps（步数）
  - [x] calories（卡路里消耗）
  - [x] exercise_minutes（运动时长）
  - [x] weight（体重）
  - [x] sleep_hours（睡眠时长）
  - [x] 创建唯一索引（user_id, date）

- [x] 设计聊天上下文表（ChatContext）结构
  - [x] chat_id（主键）
  - [x] user_id（用户ID）
  - [x] timestamp（时间戳）
  - [x] role（角色：user/pet）
  - [x] message（消息内容）
  - [x] context_length（上下文长度）

### 2. 数据库初始化
- [x] 创建数据库实例（腾讯云MongoDB/MySQL）
- [x] 配置数据库连接参数
- [x] 执行建表SQL脚本
- [x] 插入初始任务数据
- [ ] 设置数据库备份策略
- [ ] 配置数据库监控和告警

### 3. 数据库权限与安全
- [ ] 配置用户数据隔离（基于openid）
- [ ] 设置数据库访问权限
- [ ] 实现数据加密存储
- [ ] 配置数据库防火墙规则
- [ ] 实现敏感数据脱敏

## 云函数开发

### 1. 用户管理相关云函数
- [x] 用户登录云函数（login）
  - [x] 获取微信用户信息
  - [x] 生成或更新用户记录
  - [x] 返回用户基本信息和宠物状态
  - [x] 处理首次登录逻辑

- [x] 用户信息更新云函数（updateUserInfo）
  - [x] 更新用户昵称、头像
  - [x] 更新宠物名称、形象
  - [x] 数据验证和安全检查

### 2. 宠物管理相关云函数
- [x] 获取宠物状态云函数（getPetStatus）
  - [x] 查询宠物当前状态
  - [x] 计算实时状态值
  - [x] 返回宠物形象和动画状态

- [x] 更新宠物状态云函数（updatePetStatus）
  - [x] 根据任务完成情况更新经验值
  - [x] 计算等级提升
  - [x] 更新健康值、活力值、亲密度
  - [x] 触发升级奖励逻辑

- [x] 宠物互动云函数（petInteraction）
  - [x] 处理用户与宠物的互动
  - [x] 增加亲密度
  - [x] 触发宠物动画反馈

### 3. 任务管理相关云函数
- [x] 获取每日任务云函数（getDailyTasks）
  - [x] 查询用户当日任务列表
  - [x] 返回任务完成状态和进度
  - [x] 计算任务完成率

- [x] 完成任务云函数（completeTask）
  - [x] 标记任务完成
  - [x] 计算经验奖励
  - [x] 更新宠物状态
  - [x] 记录完成时间

- [x] 任务进度更新云函数（updateTaskProgress）
  - [x] 更新任务当前进度
  - [x] 自动检查是否达成目标
  - [x] 处理自动完成逻辑

### 4. 健康数据相关云函数
- [x] 同步微信运动数据云函数（syncWeRunData）
  - [x] 调用微信运动API
  - [x] 解密步数数据
  - [x] 更新健康数据表
  - [x] 自动更新相关任务进度

- [x] 获取健康数据云函数（getHealthData）
  - [x] 查询用户历史健康数据
  - [x] 按时间范围筛选
  - [x] 计算统计指标
  - [x] 生成趋势分析

- [x] 手动录入健康数据云函数（inputHealthData）
  - [x] 接收用户手动输入的数据
  - [x] 数据验证和格式化
  - [x] 更新健康数据表

### 5. 聊天功能相关云函数
- [x] 宠物聊天云函数（petChat）
  - [x] 接收用户消息
  - [x] 构建对话上下文
  - [x] 调用大语言模型API
  - [x] 返回宠物回复
  - [x] 保存聊天记录

- [x] 获取聊天历史云函数（getChatHistory）
  - [x] 查询用户聊天记录
  - [x] 分页返回历史消息
  - [x] 清理过期聊天记录

## 大语言模型接入

### 1. 模型服务选择与配置
- [x] 评估不同模型服务商
  - [x] OpenAI GPT系列
  - [x] 腾讯云混元大模型
  - [x] Moonshot AI
  - [x] 其他国产大模型

- [x] 申请API密钥和配置
  - [x] 获取API访问凭证
  - [x] 配置调用限额和计费
  - [x] 设置安全存储机制

### 2. 对话系统设计
- [x] 设计宠物人格和对话风格
  - [x] 编写系统提示词（System Prompt）
  - [x] 定义宠物性格特征
  - [x] 设计对话模板和回复风格

- [x] 实现上下文管理
  - [x] 维护对话历史
  - [x] 控制上下文长度
  - [x] 实现上下文压缩策略

- [x] 集成用户和宠物状态
  - [x] 在对话中融入宠物当前状态
  - [x] 根据用户健康数据调整回复
  - [x] 提供个性化健康建议

### 3. API调用优化
- [x] 实现请求队列和限流
  - [x] 防止并发请求过多
  - [x] 实现请求重试机制
  - [x] 设置超时处理

- [x] 缓存和性能优化
  - [x] 缓存常见问题回复
  - [x] 实现流式响应（可选）
  - [x] 优化Token使用效率

### 4. 内容安全与审核
- [ ] 集成内容安全API
  - [ ] 腾讯云内容安全服务
  - [ ] 敏感词过滤
  - [ ] 不当内容检测

- [ ] 实现内容审核流程
  - [ ] 用户输入预处理
  - [ ] 模型输出后处理
  - [ ] 违规内容替换策略

## 数据同步与计算

### 1. 定时任务设计
- [x] 每日数据统计任务
  - [x] 计算用户每日完成情况
  - [x] 更新宠物状态值
  - [x] 生成每日报告

- [x] 宠物状态更新任务
  - [x] 定时衰减机制
  - [x] 长期未互动处理
  - [x] 状态值边界检查

### 2. 实时数据处理
- [x] 任务完成实时响应
  - [x] 即时更新经验值
  - [x] 触发升级检查
  - [x] 推送完成通知

- [x] 微信运动数据同步
  - [x] 定时拉取最新步数
  - [x] 增量更新机制
  - [x] 数据一致性保证

## 性能优化与监控

### 1. 数据库优化
- [ ] 查询性能优化
  - [ ] 添加必要索引
  - [ ] 优化慢查询
  - [ ] 实现读写分离

- [ ] 数据归档策略
  - [ ] 历史数据清理
  - [ ] 冷热数据分离
  - [ ] 备份恢复机制

### 2. 云函数优化
- [ ] 冷启动优化
  - [ ] 减少依赖包大小
  - [ ] 实现连接池
  - [ ] 预热机制

- [ ] 并发处理优化
  - [ ] 异步处理机制
  - [ ] 批量操作优化
  - [ ] 资源使用监控

### 3. 监控与告警
- [ ] 系统监控配置
  - [ ] API调用监控
  - [ ] 数据库性能监控
  - [ ] 错误率监控

- [ ] 告警机制设置
  - [ ] 异常情况告警
  - [ ] 性能阈值告警
  - [ ] 资源使用告警

## 安全与合规

### 1. 数据安全
- [ ] 用户数据加密
  - [ ] 敏感信息加密存储
  - [ ] 传输过程加密
  - [ ] 密钥管理机制

- [ ] 访问控制
  - [ ] API鉴权机制
  - [ ] 用户权限验证
  - [ ] 防止数据泄露

### 2. 隐私保护
- [ ] 隐私政策实施
  - [ ] 数据收集最小化
  - [ ] 用户同意机制
  - [ ] 数据删除权实现

- [ ] 合规性检查
  - [ ] 个人信息保护法合规
  - [ ] 微信小程序规范遵循
  - [ ] 数据跨境传输合规

## 测试与部署

### 1. 单元测试
- [ ] 云函数单元测试
  - [ ] 核心业务逻辑测试
  - [ ] 边界条件测试
  - [ ] 异常处理测试

- [ ] 数据库操作测试
  - [ ] CRUD操作测试
  - [ ] 数据一致性测试
  - [ ] 并发操作测试

### 2. 集成测试
- [ ] API接口测试
  - [ ] 接口功能测试
  - [ ] 性能压力测试
  - [ ] 安全性测试

- [ ] 端到端测试
  - [ ] 完整业务流程测试
  - [ ] 用户场景模拟测试
  - [ ] 兼容性测试

### 3. 部署与发布
- [ ] 环境配置
  - [ ] 开发环境搭建
  - [ ] 测试环境配置
  - [ ] 生产环境部署

- [ ] 发布流程
  - [ ] 灰度发布策略
  - [ ] 回滚机制
  - [ ] 发布后验证

## 运维与维护

### 1. 日常运维
- [ ] 系统健康检查
  - [ ] 服务可用性监控
  - [ ] 性能指标跟踪
  - [ ] 资源使用情况

- [ ] 数据备份与恢复
  - [ ] 定期数据备份
  - [ ] 备份数据验证
  - [ ] 灾难恢复演练

### 2. 持续优化
- [ ] 性能调优
  - [ ] 根据监控数据优化
  - [ ] 用户反馈处理
  - [ ] 新功能迭代

- [ ] 成本控制
  - [ ] 资源使用优化
  - [ ] API调用成本控制
  - [ ] 存储成本优化

---

## 开发优先级建议

### 第一阶段（核心功能）
1. 用户登录和基础数据表
2. 宠物状态管理
3. 基础任务系统
4. 微信运动数据同步

### 第二阶段（增强功能）
1. 大语言模型聊天功能
2. 健康数据统计分析
3. 宠物成长系统完善
4. 性能优化

### 第三阶段（完善功能）
1. 高级监控告警
2. 安全合规完善
3. 用户体验优化
4. 运维自动化

---

**注意事项：**
- 所有涉及用户隐私的功能都需要严格遵循相关法规
- API密钥等敏感信息必须安全存储，不得暴露在代码中
- 大语言模型调用需要考虑成本控制和内容安全
- 定期备份数据，确保业务连续性