# 健康养宠小程序后端架构实现说明

## 概述

本项目后端基于微信云开发平台构建，使用云函数处理业务逻辑，云数据库存储数据，集成DeepSeek大语言模型实现宠物聊天功能。

## 技术栈

- **云平台**: 微信云开发
- **运行环境**: Node.js
- **数据库**: 云数据库（MongoDB）
- **大语言模型**: DeepSeek API
- **HTTP客户端**: Axios

## 云函数架构

### 1. 用户管理 - login

**功能**: 处理用户登录、注册和基础信息管理

**主要方法**:
- 获取微信用户信息
- 创建新用户记录
- 初始化默认宠物
- 生成每日任务记录

**调用示例**:
```javascript
wx.cloud.callFunction({
  name: 'login',
  data: {
    userInfo: {
      nickName: '用户昵称',
      avatarUrl: '头像URL',
      gender: 1,
      city: '城市'
    }
  }
})
```

### 2. 宠物聊天 - petChat

**功能**: 集成DeepSeek大模型，实现宠物智能对话

**特性**:
- 基于宠物状态的个性化回复
- 维护对话上下文（最近10轮）
- 自动增加宠物亲密度
- 内容安全过滤

**调用示例**:
```javascript
wx.cloud.callFunction({
  name: 'petChat',
  data: {
    message: '你好，小宠物！'
  }
})
```

### 3. 数据库初始化 - initDatabase

**功能**: 创建数据库表结构和初始化数据

**创建的集合**:
- `pet_users` - 用户表
- `pets` - 宠物表
- `tasks` - 任务定义表
- `task_records` - 任务记录表
- `health_data` - 健康数据表
- `chat_context` - 聊天上下文表

**调用示例**:
```javascript
wx.cloud.callFunction({
  name: 'initDatabase'
})
```

### 4. 任务管理 - taskManager

**功能**: 处理任务相关的所有操作

**支持的操作**:
- `getDailyTasks` - 获取每日任务
- `completeTask` - 完成任务
- `updateTaskProgress` - 更新任务进度
- `getTaskStats` - 获取任务统计

**调用示例**:
```javascript
wx.cloud.callFunction({
  name: 'taskManager',
  data: {
    action: 'getDailyTasks'
  }
})
```

### 5. 健康数据管理 - healthDataManager

**功能**: 处理健康数据同步和管理

**支持的操作**:
- `syncWeRunData` - 同步微信运动数据
- `getHealthData` - 获取健康数据
- `inputHealthData` - 手动录入健康数据
- `getHealthStats` - 获取健康统计

**调用示例**:
```javascript
wx.cloud.callFunction({
  name: 'healthDataManager',
  data: {
    action: 'syncWeRunData',
    encryptedData: '加密数据',
    iv: '初始向量'
  }
})
```

### 6. 宠物管理 - petManager

**功能**: 处理宠物状态和互动

**支持的操作**:
- `getPetStatus` - 获取宠物状态
- `updatePetInfo` - 更新宠物信息
- `feedPet` - 喂养宠物
- `playWithPet` - 与宠物玩耍
- `petLevelUp` - 宠物升级
- `getPetHistory` - 获取宠物历史

**调用示例**:
```javascript
wx.cloud.callFunction({
  name: 'petManager',
  data: {
    action: 'getPetStatus'
  }
})
```

## 数据库设计

### 用户表 (pet_users)
```javascript
{
  user_id: String,      // 微信openid
  nickname: String,     // 昵称
  avatar_url: String,   // 头像URL
  gender: Number,       // 性别
  city: String,         // 城市
  join_date: Date,      // 注册日期
  last_login: Date      // 最后登录时间
}
```

### 宠物表 (pets)
```javascript
{
  user_id: String,      // 关联用户ID
  pet_name: String,     // 宠物名称
  species: String,      // 宠物类型
  level: Number,        // 等级
  exp: Number,          // 经验值
  health: Number,       // 健康值 (0-100)
  vitality: Number,     // 活力值 (0-100)
  intimacy: Number,     // 亲密度 (0-100)
  last_active: Date,    // 最后活跃时间
  last_feed_time: Date, // 最后喂养时间
  last_play_time: Date  // 最后玩耍时间
}
```

### 任务定义表 (tasks)
```javascript
{
  name: String,         // 任务名称
  category: String,     // 任务类别
  target_value: Number, // 目标值
  unit: String,         // 单位
  reward_exp: Number,   // 经验奖励
  reward_item: String,  // 其他奖励
  is_active: Boolean,   // 是否启用
  description: String   // 任务描述
}
```

### 任务记录表 (task_records)
```javascript
{
  user_id: String,      // 用户ID
  date: String,         // 日期 (YYYY-MM-DD)
  task_id: String,      // 任务ID
  status: String,       // 状态 (pending/completed)
  progress: Number,     // 当前进度
  target_value: Number, // 目标值
  completed_at: Date    // 完成时间
}
```

### 健康数据表 (health_data)
```javascript
{
  user_id: String,      // 用户ID
  date: String,         // 日期 (YYYY-MM-DD)
  steps: Number,        // 步数
  calories: Number,     // 卡路里消耗
  exercise_minutes: Number, // 运动时长
  weight: Number,       // 体重
  sleep_hours: Number,  // 睡眠时长
  created_at: Date,     // 创建时间
  updated_at: Date      // 更新时间
}
```

### 聊天上下文表 (chat_context)
```javascript
{
  user_id: String,      // 用户ID
  role: String,         // 角色 (user/pet)
  message: String,      // 消息内容
  timestamp: Date       // 时间戳
}
```

## DeepSeek大模型集成

### API配置
- **API Key**: 存储在环境变量中
- **模型**: deepseek-chat
- **最大Token**: 150
- **温度**: 0.8

### 系统提示词设计
```javascript
const systemPrompt = `你是一只名叫"${pet.pet_name}"的可爱${pet.species === 'cat' ? '小猫咪' : '小狗狗'}，是用户"${user.nickname}"的虚拟宠物伙伴。

你的当前状态：
- 等级：${pet.level}
- 健康值：${pet.health}/100
- 活力值：${pet.vitality}/100
- 亲密度：${pet.intimacy}/100

你的性格特点：
- 活泼可爱，充满好奇心
- 关心主人的健康和生活
- 会根据自己的状态表现不同的情绪
- 喜欢鼓励主人完成健康任务
- 说话方式可爱，偶尔会用"喵~"或"汪~"等拟声词

请用温暖、可爱的语气回复主人，回复长度控制在50字以内。如果健康值或活力值较低，要表现出需要关爱的样子。`;
```

## 部署指南

### 1. 环境准备
- 安装微信开发者工具
- 配置云开发环境
- 获取DeepSeek API密钥

### 2. 部署步骤
```bash
# 1. 进入项目目录
cd /Users/wujianxiang/WeChatProjects/healthypetcompanion

# 2. 执行部署脚本
./deploy-cloudfunctions.sh

# 3. 初始化数据库
# 在微信开发者工具中调用 initDatabase 云函数
```

### 3. 配置检查
- 确认所有云函数部署成功
- 检查数据库集合是否创建
- 测试DeepSeek API连接
- 验证用户登录流程

## 安全考虑

### 1. 数据安全
- 用户数据基于openid隔离
- 敏感信息加密存储
- API密钥安全管理

### 2. 访问控制
- 云函数自动验证用户身份
- 防止跨用户数据访问
- 输入参数验证

### 3. 内容安全
- 大模型输出内容过滤
- 用户输入内容检查
- 违规内容处理机制

## 性能优化

### 1. 数据库优化
- 合理设计索引
- 控制查询范围
- 实现数据分页

### 2. 云函数优化
- 减少冷启动时间
- 复用数据库连接
- 异步处理机制

### 3. API调用优化
- 控制调用频率
- 实现请求缓存
- 错误重试机制

## 监控与维护

### 1. 日志监控
- 云函数执行日志
- 错误信息收集
- 性能指标跟踪

### 2. 数据备份
- 定期数据备份
- 备份数据验证
- 灾难恢复计划

### 3. 版本管理
- 云函数版本控制
- 灰度发布策略
- 回滚机制

## 扩展计划

### 1. 功能扩展
- 多宠物支持
- 社交功能
- 成就系统
- 商城系统

### 2. 技术升级
- 性能优化
- 安全加固
- 新技术集成
- 跨平台支持

---

**注意事项**:
1. 部署前请确保已配置好云开发环境
2. DeepSeek API密钥需要妥善保管
3. 定期检查云函数运行状态
4. 关注用户反馈，持续优化体验