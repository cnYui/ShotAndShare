# 健康养宠小程序后端测试指南

## 概述
本指南将帮助你完成后端云函数的部署、数据库初始化以及功能测试，确保后端系统正常运行。

## 前置条件

### 1. 环境准备
- 已安装微信开发者工具
- 已创建微信小程序项目并开通云开发
- 已配置云开发环境

### 2. 项目配置
确保 `project.config.json` 中的 `appid` 已正确配置为你的小程序 AppID。

## 部署步骤

### 第一步：部署云函数

#### 方法一：使用部署脚本（推荐）
```bash
# 在项目根目录执行
cd /Users/wujianxiang/WeChatProjects/healthypetcompanion
chmod +x deploy-cloudfunctions.sh
./deploy-cloudfunctions.sh
```

#### 方法二：手动部署
1. 打开微信开发者工具
2. 导入项目：选择 `healthypetcompanion` 文件夹
3. 在云开发控制台中，逐个上传以下云函数：
   - `login` - 用户登录管理
   - `petChat` - 智能聊天功能
   - `initDatabase` - 数据库初始化
   - `taskManager` - 任务管理
   - `healthDataManager` - 健康数据管理
   - `petManager` - 宠物管理
   - `quickstartFunctions` - 快速启动功能

### 第二步：初始化数据库

1. 在微信开发者工具的云开发控制台中，找到 `initDatabase` 云函数
2. 点击「测试」按钮，执行云函数
3. 查看返回结果，应该看到类似以下内容：
```json
{
  "success": true,
  "data": [
    "用户表创建成功",
    "宠物表创建成功", 
    "任务表创建成功并初始化数据",
    "任务记录表创建成功",
    "健康数据表创建成功",
    "聊天上下文表创建成功"
  ]
}
```

### 第三步：验证数据库创建

1. 在云开发控制台中，点击「数据库」
2. 确认以下集合已创建：
   - `pet_users` - 用户信息表
   - `pets` - 宠物信息表
   - `tasks` - 任务定义表（包含8个默认任务）
   - `task_records` - 任务记录表
   - `health_data` - 健康数据表
   - `chat_context` - 聊天上下文表

3. 检查 `tasks` 表中是否有默认数据：
   - 每日步行（8000步）
   - 喝水打卡（8杯）
   - 早睡早起
   - 运动锻炼（30分钟）
   - 健康饮食（3餐）
   - 与宠物聊天（5次）
   - 冥想放松（10分钟）
   - 阅读学习（30分钟）

## 功能测试

### 1. 用户登录测试

**测试云函数：** `login`

**测试参数：**
```json
{
  "code": "模拟的微信登录code",
  "userInfo": {
    "nickName": "测试用户",
    "avatarUrl": "https://example.com/avatar.jpg"
  }
}
```

**预期结果：**
```json
{
  "success": true,
  "data": {
    "openid": "用户openid",
    "user": {
      "_id": "用户ID",
      "openid": "用户openid",
      "nickname": "测试用户",
      "avatar_url": "头像URL",
      "level": 1,
      "exp": 0
    }
  }
}
```

### 2. 宠物管理测试

**测试云函数：** `petManager`

#### 创建宠物
**测试参数：**
```json
{
  "action": "create",
  "petData": {
    "name": "小白",
    "type": "cat",
    "breed": "英短",
    "age": 2,
    "gender": "female"
  }
}
```

#### 获取宠物列表
**测试参数：**
```json
{
  "action": "list"
}
```

### 3. 任务管理测试

**测试云函数：** `taskManager`

#### 获取任务列表
**测试参数：**
```json
{
  "action": "getTasks"
}
```

#### 完成任务
**测试参数：**
```json
{
  "action": "completeTask",
  "taskId": "任务ID",
  "value": 8000
}
```

### 4. 智能聊天测试

**测试云函数：** `petChat`

**测试参数：**
```json
{
  "message": "你好，小宠物！",
  "petId": "宠物ID"
}
```

**预期结果：**
应该返回AI生成的回复内容。

### 5. 健康数据测试

**测试云函数：** `healthDataManager`

#### 添加健康数据
**测试参数：**
```json
{
  "action": "add",
  "data": {
    "type": "steps",
    "value": 8000,
    "date": "2024-01-15"
  }
}
```

#### 获取健康数据
**测试参数：**
```json
{
  "action": "get",
  "type": "steps",
  "startDate": "2024-01-01",
  "endDate": "2024-01-31"
}
```

## 常见问题排查

### 1. 云函数部署失败
- 检查网络连接
- 确认微信开发者工具已登录
- 检查云开发环境是否正确配置
- 查看云函数代码是否有语法错误

### 2. 数据库初始化失败
- 检查云开发权限设置
- 确认环境变量配置正确
- 查看云函数日志获取详细错误信息

### 3. 云函数调用失败
- 检查函数参数格式是否正确
- 确认用户权限和登录状态
- 查看云函数运行日志

### 4. DeepSeek API调用失败
- 检查 `.env` 文件中的API密钥配置
- 确认网络可以访问DeepSeek API
- 检查API调用频率是否超限

## 数据查看方式

### 在微信开发者工具中查看
1. 打开云开发控制台
2. 点击「数据库」
3. 选择对应的集合查看数据

### 通过云函数查看
可以编写简单的查询云函数来获取数据：
```javascript
// 示例：查询所有用户
const users = await db.collection('pet_users').get();
console.log(users.data);
```

## 性能监控

1. 在云开发控制台中查看云函数调用统计
2. 监控数据库读写次数
3. 查看云函数执行时间和内存使用情况

## 下一步

完成后端测试后，你可以：
1. 开始前端小程序开发
2. 集成前后端功能
3. 进行端到端测试
4. 优化性能和用户体验

---

**注意：** 测试过程中产生的数据都会保存在云数据库中，建议在正式发布前清理测试数据。