# 国际化系统实现详解

## 系统架构概述

### 设计理念
- **统一管理**：所有文本资源集中管理
- **动态切换**：运行时语言切换
- **向后兼容**：保留硬编码文本作为备用
- **扩展性强**：易于添加新语言
- **性能优化**：按需加载语言包

### 技术架构

```
国际化系统架构
├── i18n/
│   ├── index.js           # 核心国际化引擎
│   ├── zh-cn.js          # 简体中文语言包
│   ├── zh-tw.js          # 繁体中文语言包
│   ├── en.js             # 英文语言包
│   └── config.js         # 配置文件
├── utils/
│   ├── basePage.js       # 页面基类
│   └── themeManager.js   # 主题管理器
└── pages/
    └── */
        └── *.js          # 各页面实现
```

## 核心组件实现

### 1. 国际化引擎 (i18n/index.js)

```javascript
// 国际化核心引擎
class I18n {
  constructor() {
    this.currentLanguage = 'zh-cn';  // 默认语言
    this.fallbackLanguage = 'zh-cn'; // 备用语言
    this.languages = {};              // 语言包缓存
    this.observers = [];              // 观察者列表
    
    this.init();
  }
  
  /**
   * 初始化国际化系统
   */
  async init() {
    try {
      // 从本地存储获取用户语言设置
      const savedLanguage = wx.getStorageSync('language');
      if (savedLanguage) {
        this.currentLanguage = savedLanguage;
      } else {
        // 获取系统语言
        const systemInfo = wx.getSystemInfoSync();
        const systemLanguage = this.getSystemLanguage(systemInfo.language);
        this.currentLanguage = systemLanguage;
      }
      
      // 加载当前语言包
      await this.loadLanguage(this.currentLanguage);
      
      console.log(`[I18n] 初始化完成，当前语言: ${this.currentLanguage}`);
    } catch (error) {
      console.error('[I18n] 初始化失败:', error);
      // 降级到默认语言
      this.currentLanguage = this.fallbackLanguage;
      await this.loadLanguage(this.currentLanguage);
    }
  }
  
  /**
   * 获取系统语言对应的语言代码
   */
  getSystemLanguage(systemLang) {
    const languageMap = {
      'zh_CN': 'zh-cn',
      'zh-CN': 'zh-cn',
      'zh_TW': 'zh-tw',
      'zh-TW': 'zh-tw',
      'zh-HK': 'zh-tw',
      'en': 'en',
      'en_US': 'en',
      'en-US': 'en'
    };
    
    return languageMap[systemLang] || 'zh-cn';
  }
  
  /**
   * 加载语言包
   */
  async loadLanguage(language) {
    if (this.languages[language]) {
      return this.languages[language];
    }
    
    try {
      let languageData;
      
      // 动态导入语言包
      switch (language) {
        case 'zh-cn':
          languageData = require('./zh-cn.js');
          break;
        case 'zh-tw':
          languageData = require('./zh-tw.js');
          break;
        case 'en':
          languageData = require('./en.js');
          break;
        default:
          languageData = require('./zh-cn.js');
      }
      
      this.languages[language] = languageData;
      console.log(`[I18n] 语言包加载成功: ${language}`);
      
      return languageData;
    } catch (error) {
      console.error(`[I18n] 语言包加载失败: ${language}`, error);
      
      // 如果不是备用语言，尝试加载备用语言
      if (language !== this.fallbackLanguage) {
        return await this.loadLanguage(this.fallbackLanguage);
      }
      
      throw error;
    }
  }
  
  /**
   * 获取翻译文本
   * @param {string} key - 文本键值，支持点号分隔的嵌套路径
   * @param {object} params - 参数对象，用于文本插值
   * @param {string} defaultText - 默认文本
   */
  t(key, params = {}, defaultText = '') {
    try {
      const languageData = this.languages[this.currentLanguage];
      if (!languageData) {
        console.warn(`[I18n] 语言包未加载: ${this.currentLanguage}`);
        return defaultText || key;
      }
      
      // 解析嵌套键值
      const text = this.getNestedValue(languageData, key);
      
      if (text === undefined || text === null) {
        console.warn(`[I18n] 翻译文本未找到: ${key}`);
        
        // 尝试从备用语言获取
        const fallbackData = this.languages[this.fallbackLanguage];
        if (fallbackData && this.currentLanguage !== this.fallbackLanguage) {
          const fallbackText = this.getNestedValue(fallbackData, key);
          if (fallbackText) {
            return this.interpolate(fallbackText, params);
          }
        }
        
        return defaultText || key;
      }
      
      // 文本插值
      return this.interpolate(text, params);
    } catch (error) {
      console.error(`[I18n] 获取翻译文本失败: ${key}`, error);
      return defaultText || key;
    }
  }
  
  /**
   * 获取嵌套对象的值
   */
  getNestedValue(obj, path) {
    return path.split('.').reduce((current, key) => {
      return current && current[key] !== undefined ? current[key] : undefined;
    }, obj);
  }
  
  /**
   * 文本插值
   */
  interpolate(text, params) {
    if (!params || Object.keys(params).length === 0) {
      return text;
    }
    
    return text.replace(/\{\{(\w+)\}\}/g, (match, key) => {
      return params[key] !== undefined ? params[key] : match;
    });
  }
  
  /**
   * 切换语言
   */
  async setLanguage(language) {
    if (language === this.currentLanguage) {
      return;
    }
    
    try {
      // 加载新语言包
      await this.loadLanguage(language);
      
      const oldLanguage = this.currentLanguage;
      this.currentLanguage = language;
      
      // 保存到本地存储
      wx.setStorageSync('language', language);
      
      // 通知观察者
      this.notifyObservers({
        type: 'languageChanged',
        oldLanguage,
        newLanguage: language
      });
      
      console.log(`[I18n] 语言切换成功: ${oldLanguage} -> ${language}`);
    } catch (error) {
      console.error(`[I18n] 语言切换失败: ${language}`, error);
      throw error;
    }
  }
  
  /**
   * 获取当前语言
   */
  getCurrentLanguage() {
    return this.currentLanguage;
  }
  
  /**
   * 获取支持的语言列表
   */
  getSupportedLanguages() {
    return [
      { code: 'zh-cn', name: '简体中文', nativeName: '简体中文' },
      { code: 'zh-tw', name: '繁体中文', nativeName: '繁體中文' },
      { code: 'en', name: 'English', nativeName: 'English' }
    ];
  }
  
  /**
   * 添加观察者
   */
  addObserver(observer) {
    this.observers.push(observer);
  }
  
  /**
   * 移除观察者
   */
  removeObserver(observer) {
    const index = this.observers.indexOf(observer);
    if (index > -1) {
      this.observers.splice(index, 1);
    }
  }
  
  /**
   * 通知观察者
   */
  notifyObservers(event) {
    this.observers.forEach(observer => {
      if (typeof observer === 'function') {
        observer(event);
      } else if (observer.onLanguageChange) {
        observer.onLanguageChange(event);
      }
    });
  }
  
  /**
   * 获取所有翻译文本（用于页面初始化）
   */
  getAllTexts() {
    const languageData = this.languages[this.currentLanguage];
    return languageData || {};
  }
  
  /**
   * 预加载语言包
   */
  async preloadLanguages(languages = []) {
    const loadPromises = languages.map(lang => this.loadLanguage(lang));
    await Promise.all(loadPromises);
  }
}

// 创建全局实例
const i18n = new I18n();

module.exports = i18n;
```

### 2. 语言包结构 (zh-cn.js)

```javascript
// 简体中文语言包
module.exports = {
  // 通用文本
  common: {
    confirm: '确认',
    cancel: '取消',
    save: '保存',
    delete: '删除',
    edit: '编辑',
    add: '添加',
    search: '搜索',
    loading: '加载中...',
    noData: '暂无数据',
    error: '出错了',
    success: '成功',
    failed: '失败',
    retry: '重试',
    back: '返回',
    next: '下一步',
    previous: '上一步',
    finish: '完成',
    skip: '跳过',
    close: '关闭',
    open: '打开',
    enable: '启用',
    disable: '禁用',
    on: '开启',
    off: '关闭',
    yes: '是',
    no: '否',
    today: '今天',
    yesterday: '昨天',
    tomorrow: '明天',
    thisWeek: '本周',
    thisMonth: '本月',
    thisYear: '今年'
  },
  
  // 登录页面
  login: {
    title: '欢迎使用健康宠物伴侣',
    subtitle: '让AI陪伴您的健康生活',
    loginButton: '微信登录',
    authRequired: '需要授权才能使用',
    loginSuccess: '登录成功',
    loginFailed: '登录失败，请重试',
    registerSuccess: '注册成功，欢迎加入！',
    privacyTip: '登录即表示同意《用户协议》和《隐私政策》',
    userAgreement: '用户协议',
    privacyPolicy: '隐私政策'
  },
  
  // 主页
  home: {
    title: '宠物主页',
    welcome: '欢迎回来，{{name}}！',
    petStatus: {
      veryHappy: '非常开心',
      happy: '开心',
      normal: '一般',
      needCare: '需要关爱',
      sick: '生病了'
    },
    petActions: {
      feed: '喂食',
      play: '玩耍',
      exercise: '运动',
      rest: '休息'
    },
    stats: {
      level: '等级',
      experience: '经验值',
      health: '健康值',
      happiness: '快乐值',
      energy: '活力值',
      intelligence: '智力值'
    },
    achievements: {
      title: '成就',
      newAchievement: '获得新成就：{{achievement}}',
      viewAll: '查看全部'
    },
    quickActions: {
      addData: '记录数据',
      viewTasks: '查看任务',
      chatWithPet: '与宠物聊天'
    }
  },
  
  // 健康数据页面
  data: {
    title: '健康数据',
    tabs: {
      overview: '概览',
      steps: '步数',
      water: '饮水',
      sleep: '睡眠',
      exercise: '运动',
      mood: '心情'
    },
    overview: {
      todayStats: '今日数据',
      weeklyTrend: '本周趋势',
      monthlyReport: '月度报告',
      healthScore: '健康评分'
    },
    steps: {
      title: '今日步数',
      target: '目标：{{target}}步',
      distance: '距离：{{distance}}公里',
      calories: '消耗：{{calories}}卡路里',
      sync: '同步微信运动',
      syncSuccess: '同步成功',
      syncFailed: '同步失败'
    },
    water: {
      title: '饮水记录',
      target: '目标：{{target}}ml',
      addRecord: '添加饮水记录',
      amount: '饮水量',
      time: '时间',
      type: '类型',
      types: {
        water: '白开水',
        tea: '茶',
        coffee: '咖啡',
        juice: '果汁'
      }
    },
    sleep: {
      title: '睡眠记录',
      duration: '睡眠时长：{{hours}}小时',
      quality: '睡眠质量：{{quality}}/5',
      bedTime: '就寝时间',
      wakeTime: '起床时间',
      stages: {
        deep: '深度睡眠',
        light: '浅度睡眠',
        rem: 'REM睡眠',
        awake: '清醒'
      }
    },
    exercise: {
      title: '运动记录',
      addRecord: '添加运动记录',
      type: '运动类型',
      duration: '持续时间',
      intensity: '强度',
      calories: '消耗卡路里',
      types: {
        running: '跑步',
        walking: '步行',
        cycling: '骑行',
        swimming: '游泳',
        yoga: '瑜伽',
        fitness: '健身'
      },
      intensities: {
        low: '低强度',
        medium: '中强度',
        high: '高强度'
      }
    },
    mood: {
      title: '心情记录',
      todayMood: '今日心情',
      score: '心情评分：{{score}}/10',
      tags: '心情标签',
      note: '心情备注',
      moodTags: {
        happy: '开心',
        sad: '难过',
        excited: '兴奋',
        calm: '平静',
        stressed: '压力',
        tired: '疲惫',
        energetic: '精力充沛',
        anxious: '焦虑'
      }
    },
    charts: {
      daily: '日',
      weekly: '周',
      monthly: '月',
      yearly: '年',
      trend: '趋势',
      average: '平均值',
      target: '目标值'
    }
  },
  
  // 任务页面
  tasks: {
    title: '健康任务',
    tabs: {
      today: '今日',
      weekly: '本周',
      monthly: '本月',
      completed: '已完成'
    },
    categories: {
      all: '全部',
      health: '健康',
      exercise: '运动',
      sleep: '睡眠',
      water: '饮水',
      social: '社交'
    },
    status: {
      pending: '待完成',
      inProgress: '进行中',
      completed: '已完成',
      failed: '已失败',
      expired: '已过期'
    },
    priority: {
      low: '低',
      medium: '中',
      high: '高'
    },
    difficulty: {
      easy: '简单',
      medium: '中等',
      hard: '困难'
    },
    actions: {
      start: '开始任务',
      complete: '完成任务',
      pause: '暂停任务',
      resume: '继续任务',
      abandon: '放弃任务'
    },
    rewards: {
      exp: '经验值',
      coins: '金币',
      items: '道具',
      badges: '徽章'
    },
    progress: {
      current: '当前进度',
      target: '目标',
      percentage: '完成度：{{percent}}%'
    },
    empty: {
      title: '暂无任务',
      subtitle: '完成日常活动来获得新任务吧！',
      action: '去记录数据'
    },
    completion: {
      congratulations: '恭喜完成任务！',
      rewards: '获得奖励：',
      nextTask: '下一个任务'
    }
  },
  
  // 聊天页面
  chat: {
    title: '宠物聊天',
    inputPlaceholder: '和你的宠物说点什么...',
    send: '发送',
    typing: '宠物正在思考...',
    networkError: '网络连接失败，请重试',
    aiError: 'AI服务暂时不可用',
    voiceInput: '语音输入',
    imageInput: '发送图片',
    quickReplies: {
      greeting: '你好',
      howAreYou: '你好吗？',
      healthTip: '给我一些健康建议',
      taskHelp: '帮我制定任务计划',
      encouragement: '给我一些鼓励'
    },
    feedback: {
      helpful: '有帮助',
      notHelpful: '没帮助',
      thankYou: '谢谢你的反馈！'
    },
    history: {
      today: '今天',
      yesterday: '昨天',
      earlier: '更早',
      clear: '清空聊天记录',
      confirmClear: '确定要清空所有聊天记录吗？'
    }
  },
  
  // 个人设置页面
  profile: {
    title: '个人设置',
    sections: {
      account: '账户信息',
      preferences: '偏好设置',
      notifications: '通知设置',
      privacy: '隐私设置',
      about: '关于应用'
    },
    account: {
      avatar: '头像',
      nickname: '昵称',
      signature: '个性签名',
      level: '等级',
      experience: '经验值',
      joinDate: '加入日期',
      totalDays: '陪伴天数'
    },
    preferences: {
      theme: '主题设置',
      language: '语言设置',
      themes: {
        auto: '跟随系统',
        light: '浅色模式',
        dark: '深色模式'
      },
      languages: {
        'zh-cn': '简体中文',
        'zh-tw': '繁体中文',
        'en': 'English'
      }
    },
    notifications: {
      title: '通知设置',
      taskReminder: '任务提醒',
      waterReminder: '饮水提醒',
      sleepReminder: '睡眠提醒',
      reminderTime: '提醒时间',
      waterTimes: '饮水提醒时间',
      sleepTime: '睡眠提醒时间',
      taskTime: '任务提醒时间'
    },
    privacy: {
      title: '隐私设置',
      dataSync: '数据同步',
      shareData: '数据分享',
      publicProfile: '公开资料',
      dataExport: '导出数据',
      dataDelete: '删除数据',
      confirmDelete: '确定要删除所有数据吗？此操作不可恢复。'
    },
    about: {
      version: '版本信息',
      developer: '开发者',
      contact: '联系我们',
      feedback: '意见反馈',
      userAgreement: '用户协议',
      privacyPolicy: '隐私政策',
      openSource: '开源许可'
    },
    actions: {
      logout: '退出登录',
      confirmLogout: '确定要退出登录吗？'
    },
    messages: {
      saveSuccess: '保存成功',
      saveFailed: '保存失败',
      themeChanged: '主题已切换',
      languageChanged: '语言已切换'
    }
  },
  
  // 错误信息
  errors: {
    network: '网络连接失败',
    server: '服务器错误',
    auth: '身份验证失败',
    permission: '权限不足',
    notFound: '页面不存在',
    timeout: '请求超时',
    unknown: '未知错误'
  },
  
  // 成功信息
  success: {
    save: '保存成功',
    update: '更新成功',
    delete: '删除成功',
    upload: '上传成功',
    sync: '同步成功'
  },
  
  // 时间格式
  time: {
    formats: {
      date: 'YYYY年MM月DD日',
      time: 'HH:mm',
      datetime: 'YYYY年MM月DD日 HH:mm',
      monthDay: 'MM月DD日'
    },
    units: {
      year: '年',
      month: '月',
      day: '日',
      hour: '小时',
      minute: '分钟',
      second: '秒'
    },
    relative: {
      justNow: '刚刚',
      minutesAgo: '{{minutes}}分钟前',
      hoursAgo: '{{hours}}小时前',
      daysAgo: '{{days}}天前',
      weeksAgo: '{{weeks}}周前',
      monthsAgo: '{{months}}个月前'
    }
  }
};
```

### 3. 页面基类 (utils/basePage.js)

```javascript
// 页面基类，提供国际化支持
const i18n = require('../i18n/index.js');
const themeManager = require('./themeManager.js');

class BasePage {
  constructor() {
    this.texts = {};
    this.isI18nReady = false;
  }
  
  /**
   * 页面数据
   */
  data = {
    texts: {},
    theme: 'auto',
    language: 'zh-cn'
  }
  
  /**
   * 页面加载时初始化国际化
   */
  async onLoad(options) {
    try {
      // 等待国际化系统初始化完成
      await this.waitForI18n();
      
      // 加载文本
      await this.loadTexts();
      
      // 注册语言变化监听
      this.registerLanguageObserver();
      
      // 加载主题
      this.loadTheme();
      
      // 调用子类的onLoad
      if (this.onPageLoad) {
        await this.onPageLoad(options);
      }
    } catch (error) {
      console.error('[BasePage] 页面初始化失败:', error);
    }
  }
  
  /**
   * 等待国际化系统初始化
   */
  async waitForI18n() {
    let retries = 0;
    const maxRetries = 50; // 最多等待5秒
    
    while (!this.isI18nReady && retries < maxRetries) {
      try {
        const texts = i18n.getAllTexts();
        if (texts && Object.keys(texts).length > 0) {
          this.isI18nReady = true;
          break;
        }
      } catch (error) {
        // 继续等待
      }
      
      await new Promise(resolve => setTimeout(resolve, 100));
      retries++;
    }
    
    if (!this.isI18nReady) {
      console.warn('[BasePage] 国际化系统初始化超时');
    }
  }
  
  /**
   * 加载文本资源
   */
  async loadTexts() {
    try {
      const allTexts = i18n.getAllTexts();
      this.texts = allTexts;
      
      this.setData({
        texts: allTexts,
        language: i18n.getCurrentLanguage()
      });
      
      console.log('[BasePage] 文本资源加载完成');
    } catch (error) {
      console.error('[BasePage] 文本资源加载失败:', error);
    }
  }
  
  /**
   * 注册语言变化观察者
   */
  registerLanguageObserver() {
    this.languageObserver = (event) => {
      if (event.type === 'languageChanged') {
        this.onLanguageChange(event);
      }
    };
    
    i18n.addObserver(this.languageObserver);
  }
  
  /**
   * 语言变化处理
   */
  async onLanguageChange(event) {
    try {
      console.log('[BasePage] 语言变化:', event.newLanguage);
      
      // 重新加载文本
      await this.loadTexts();
      
      // 调用子类的语言变化处理
      if (this.onPageLanguageChange) {
        this.onPageLanguageChange(event);
      }
    } catch (error) {
      console.error('[BasePage] 语言变化处理失败:', error);
    }
  }
  
  /**
   * 加载主题
   */
  loadTheme() {
    const currentTheme = themeManager.getCurrentTheme();
    this.setData({
      theme: currentTheme
    });
  }
  
  /**
   * 获取翻译文本
   */
  t(key, params = {}, defaultText = '') {
    return i18n.t(key, params, defaultText);
  }
  
  /**
   * 页面卸载时清理
   */
  onUnload() {
    // 移除语言观察者
    if (this.languageObserver) {
      i18n.removeObserver(this.languageObserver);
    }
    
    // 调用子类的onUnload
    if (this.onPageUnload) {
      this.onPageUnload();
    }
  }
  
  /**
   * 显示多语言提示
   */
  showToast(key, params = {}, options = {}) {
    const text = this.t(key, params);
    wx.showToast({
      title: text,
      icon: options.icon || 'none',
      duration: options.duration || 2000
    });
  }
  
  /**
   * 显示多语言模态框
   */
  showModal(titleKey, contentKey, params = {}, options = {}) {
    const title = this.t(titleKey, params);
    const content = this.t(contentKey, params);
    
    return new Promise((resolve) => {
      wx.showModal({
        title,
        content,
        confirmText: this.t('common.confirm'),
        cancelText: this.t('common.cancel'),
        ...options,
        success: (res) => {
          resolve(res.confirm);
        },
        fail: () => {
          resolve(false);
        }
      });
    });
  }
}

module.exports = BasePage;
```

### 4. 页面实现示例 (pages/home/home.js)

```javascript
// 主页实现示例
const BasePage = require('../../utils/basePage.js');
const petManager = require('../../utils/petManager.js');

// 继承BasePage获得国际化支持
class HomePage extends BasePage {
  data = {
    ...super.data,
    pet: null,
    userStats: null,
    quickActions: []
  }
  
  /**
   * 页面加载（由BasePage调用）
   */
  async onPageLoad(options) {
    await this.loadPetData();
    await this.loadUserStats();
    this.setupQuickActions();
  }
  
  /**
   * 语言变化处理（由BasePage调用）
   */
  onPageLanguageChange(event) {
    // 重新设置快捷操作（因为文本变了）
    this.setupQuickActions();
    
    // 重新格式化宠物状态文本
    this.updatePetStatusText();
  }
  
  /**
   * 加载宠物数据
   */
  async loadPetData() {
    try {
      const pet = await petManager.getCurrentPet();
      this.setData({ pet });
      this.updatePetStatusText();
    } catch (error) {
      console.error('加载宠物数据失败:', error);
      this.showToast('errors.unknown');
    }
  }
  
  /**
   * 更新宠物状态文本
   */
  updatePetStatusText() {
    const pet = this.data.pet;
    if (!pet) return;
    
    const statusText = this.t(`home.petStatus.${pet.mood}`);
    this.setData({
      'pet.statusText': statusText
    });
  }
  
  /**
   * 设置快捷操作
   */
  setupQuickActions() {
    const quickActions = [
      {
        id: 'addData',
        icon: 'add-circle',
        text: this.t('home.quickActions.addData'),
        url: '/pages/data/data'
      },
      {
        id: 'viewTasks',
        icon: 'task',
        text: this.t('home.quickActions.viewTasks'),
        url: '/pages/tasks/tasks'
      },
      {
        id: 'chatWithPet',
        icon: 'chat',
        text: this.t('home.quickActions.chatWithPet'),
        url: '/pages/chat/chat'
      }
    ];
    
    this.setData({ quickActions });
  }
  
  /**
   * 宠物互动
   */
  async onPetAction(e) {
    const action = e.currentTarget.dataset.action;
    
    try {
      const result = await petManager.interactWithPet(action);
      
      if (result.success) {
        // 显示成功消息
        const actionText = this.t(`home.petActions.${action}`);
        this.showToast('success.update', { action: actionText });
        
        // 更新宠物数据
        await this.loadPetData();
      } else {
        this.showToast('errors.unknown');
      }
    } catch (error) {
      console.error('宠物互动失败:', error);
      this.showToast('errors.network');
    }
  }
  
  /**
   * 快捷操作点击
   */
  onQuickAction(e) {
    const action = e.currentTarget.dataset.action;
    const url = e.currentTarget.dataset.url;
    
    if (url) {
      wx.navigateTo({ url });
    }
  }
}

// 创建页面实例
const homePage = new HomePage();

// 导出页面配置
Page({
  data: homePage.data,
  onLoad: homePage.onLoad.bind(homePage),
  onUnload: homePage.onUnload.bind(homePage),
  onPetAction: homePage.onPetAction.bind(homePage),
  onQuickAction: homePage.onQuickAction.bind(homePage)
});
```

## 国际化最佳实践

### 1. 文本键值命名规范

```javascript
// 推荐的命名规范
const namingConventions = {
  // 按模块分组
  'module.section.item': '模块.部分.项目',
  
  // 具体示例
  'home.petStatus.happy': '主页.宠物状态.开心',
  'tasks.actions.complete': '任务.操作.完成',
  'profile.settings.theme': '设置.偏好.主题',
  
  // 通用文本使用common前缀
  'common.confirm': '通用.确认',
  'common.cancel': '通用.取消',
  
  // 错误信息使用errors前缀
  'errors.network': '错误.网络',
  'errors.auth': '错误.认证',
  
  // 成功信息使用success前缀
  'success.save': '成功.保存',
  'success.update': '成功.更新'
};
```

### 2. 文本插值使用

```javascript
// 在语言包中定义带参数的文本
const textWithParams = {
  welcome: '欢迎回来，{{name}}！',
  progress: '完成度：{{percent}}%',
  timeAgo: '{{time}}前',
  reward: '获得{{exp}}经验值和{{coins}}金币'
};

// 在页面中使用
const welcomeText = this.t('home.welcome', { name: '小明' });
const progressText = this.t('tasks.progress.percentage', { percent: 75 });
```

### 3. 复数形式处理

```javascript
// 处理复数形式
const pluralTexts = {
  // 中文通常不需要复数形式
  'zh-cn': {
    itemCount: '{{count}}个项目'
  },
  
  // 英文需要处理复数
  'en': {
    itemCount: '{{count}} item{{count === 1 ? "" : "s"}}'
  }
};

// 使用复数处理函数
function getPlural(count, singular, plural) {
  return count === 1 ? singular : plural;
}
```

### 4. 日期时间国际化

```javascript
// 日期时间格式化
class DateTimeFormatter {
  constructor(language) {
    this.language = language;
    this.formats = {
      'zh-cn': {
        date: 'YYYY年MM月DD日',
        time: 'HH:mm',
        datetime: 'YYYY年MM月DD日 HH:mm'
      },
      'en': {
        date: 'MMM DD, YYYY',
        time: 'HH:mm',
        datetime: 'MMM DD, YYYY HH:mm'
      }
    };
  }
  
  formatDate(date, type = 'date') {
    const format = this.formats[this.language][type];
    return this.format(date, format);
  }
  
  getRelativeTime(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) {
      return i18n.t('time.relative.justNow');
    } else if (minutes < 60) {
      return i18n.t('time.relative.minutesAgo', { minutes });
    } else if (hours < 24) {
      return i18n.t('time.relative.hoursAgo', { hours });
    } else {
      return i18n.t('time.relative.daysAgo', { days });
    }
  }
}
```

### 5. 数字格式化

```javascript
// 数字格式化
class NumberFormatter {
  constructor(language) {
    this.language = language;
  }
  
  formatNumber(number, options = {}) {
    const locale = this.getLocale();
    return new Intl.NumberFormat(locale, options).format(number);
  }
  
  formatCurrency(amount, currency = 'CNY') {
    const locale = this.getLocale();
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency
    }).format(amount);
  }
  
  formatPercent(value) {
    const locale = this.getLocale();
    return new Intl.NumberFormat(locale, {
      style: 'percent',
      minimumFractionDigits: 1
    }).format(value / 100);
  }
  
  getLocale() {
    const localeMap = {
      'zh-cn': 'zh-CN',
      'zh-tw': 'zh-TW',
      'en': 'en-US'
    };
    return localeMap[this.language] || 'zh-CN';
  }
}
```

## 性能优化

### 1. 懒加载语言包

```javascript
// 按需加载语言包
class LazyI18n {
  constructor() {
    this.loadedModules = new Set();
    this.moduleCache = {};
  }
  
  async loadModule(moduleName) {
    if (this.loadedModules.has(moduleName)) {
      return this.moduleCache[moduleName];
    }
    
    try {
      const moduleData = await this.loadModuleData(moduleName);
      this.moduleCache[moduleName] = moduleData;
      this.loadedModules.add(moduleName);
      return moduleData;
    } catch (error) {
      console.error(`加载模块失败: ${moduleName}`, error);
      return {};
    }
  }
  
  async loadModuleData(moduleName) {
    // 动态加载模块数据
    const language = this.getCurrentLanguage();
    const modulePath = `./modules/${language}/${moduleName}.js`;
    return require(modulePath);
  }
}
```

### 2. 文本缓存策略

```javascript
// 文本缓存
class TextCache {
  constructor() {
    this.cache = new Map();
    this.maxSize = 1000;
  }
  
  get(key, params) {
    const cacheKey = this.getCacheKey(key, params);
    return this.cache.get(cacheKey);
  }
  
  set(key, params, text) {
    const cacheKey = this.getCacheKey(key, params);
    
    // 清理缓存
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    
    this.cache.set(cacheKey, text);
  }
  
  getCacheKey(key, params) {
    return `${key}:${JSON.stringify(params)}`;
  }
  
  clear() {
    this.cache.clear();
  }
}
```

## 测试策略

### 1. 单元测试

```javascript
// 国际化功能测试
describe('I18n', () => {
  let i18n;
  
  beforeEach(() => {
    i18n = new I18n();
  });
  
  test('应该正确获取翻译文本', () => {
    const text = i18n.t('common.confirm');
    expect(text).toBe('确认');
  });
  
  test('应该正确处理文本插值', () => {
    const text = i18n.t('home.welcome', { name: '测试用户' });
    expect(text).toBe('欢迎回来，测试用户！');
  });
  
  test('应该正确处理嵌套键值', () => {
    const text = i18n.t('home.petStatus.happy');
    expect(text).toBe('开心');
  });
  
  test('应该在文本不存在时返回默认值', () => {
    const text = i18n.t('nonexistent.key', {}, '默认文本');
    expect(text).toBe('默认文本');
  });
});
```

### 2. 集成测试

```javascript
// 页面国际化测试
describe('HomePage I18n', () => {
  let page;
  
  beforeEach(() => {
    page = new HomePage();
  });
  
  test('应该在语言切换时更新页面文本', async () => {
    await page.onLoad();
    
    // 切换到英文
    await i18n.setLanguage('en');
    
    // 检查页面文本是否更新
    const quickActions = page.data.quickActions;
    expect(quickActions[0].text).toBe('Add Data');
  });
});
```

## 总结

国际化系统的核心特点：

1. **统一架构**：基于观察者模式的响应式国际化系统
2. **动态切换**：支持运行时语言切换，无需重启应用
3. **向后兼容**：保留硬编码文本作为备用方案
4. **性能优化**：懒加载、缓存、按需更新
5. **易于维护**：清晰的文件结构和命名规范
6. **扩展性强**：易于添加新语言和新功能
7. **类型安全**：完整的错误处理和降级机制
8. **测试友好**：支持单元测试和集成测试

这个国际化系统为健康宠物伴侣小程序提供了完整的多语言支持，确保用户在不同语言环境下都能获得良好的使用体验。