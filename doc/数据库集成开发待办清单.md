
# 健康宠物伴侣小程序 - 数据库集成开发待办清单

## 📋 项目概述

本待办清单旨在将当前静态数据驱动的小程序转换为完整的数据库驱动应用，包括用户登录、聊天历史、健康任务系统和宠物管理系统的完整数据库集成。

---

## 🔐 第一阶段：登录功能实现

### 1.1 前端登录页面创建

**文件路径：** `/miniprogram/pages/login/`

#### 创建登录页面文件
- [ ] **login.wxml** - 登录界面布局
```xml
<view class="login-container">
  <view class="logo-section">
    <image src="/images/logo.png" class="logo"></image>
    <text class="app-name">健康宠物伴侣</text>
  </view>
  
  <view class="login-section">
    <button wx:if="{{!userInfo}}" 
            class="login-btn" 
            open-type="getUserProfile" 
            bindtap="onGetUserProfile">
      <image src="/images/wechat-icon.png" class="wechat-icon"></image>
      微信登录
    </button>
    
    <view wx:else class="user-info">
      <image src="{{userInfo.avatarUrl}}" class="avatar"></image>
      <text class="nickname">{{userInfo.nickName}}</text>
      <button class="continue-btn" bindtap="onContinue">继续使用</button>
    </view>
  </view>
</view>
```

- [ ] **login.js** - 登录逻辑实现
```javascript
Page({
  data: {
    userInfo: null,
    loading: false
  },

  onLoad() {
    this.checkLoginStatus();
  },

  // 检查登录状态
  checkLoginStatus() {
    const userInfo = wx.getStorageSync('userInfo');
    if (userInfo) {
      this.setData({ userInfo });
    }
  },

  // 获取用户信息并登录
  onGetUserProfile() {
    wx.getUserProfile({
      desc: '用于完善用户资料',
      success: (res) => {
        this.setData({ loading: true });
        this.loginWithUserInfo(res.userInfo);
      },
      fail: () => {
        wx.showToast({
          title: '需要授权才能使用',
          icon: 'none'
        });
      }
    });
  },

  // 调用登录云函数
  async loginWithUserInfo(userInfo) {
    try {
      const result = await wx.cloud.callFunction({
        name: 'login',
        data: { userInfo }
      });

      if (result.result.success) {
        const userData = result.result.data;
        
        // 保存用户信息
        wx.setStorageSync('userInfo', userData.user);
        wx.setStorageSync('petInfo', userData.pet);
        wx.setStorageSync('isLoggedIn', true);
        
        this.setData({ 
          userInfo: userData.user,
          loading: false 
        });
        
        wx.showToast({
          title: userData.isNewUser ? '注册成功' : '登录成功',
          icon: 'success'
        });
        
        setTimeout(() => this.navigateBack(), 1500);
      } else {
        throw new Error(result.result.error);
      }
    } catch (error) {
      console.error('登录失败:', error);
      this.setData({ loading: false });
      wx.showToast({
        title: '登录失败，请重试',
        icon: 'none'
      });
    }
  },

  onContinue() {
    this.navigateBack();
  },

  navigateBack() {
    const pages = getCurrentPages();
    if (pages.length > 1) {
      wx.navigateBack();
    } else {
      wx.switchTab({ url: '/pages/index/index' });
    }
  }
});
```

- [ ] **login.wxss** - 登录页面样式

### 1.2 全局登录状态管理

#### 修改 app.js
- [ ] **添加全局登录检查**
```javascript
App({
  globalData: {
    env: "cloud1-6g4qsd2kcddd1be0",
    userInfo: null,
    petInfo: null,
    isLoggedIn: false
  },

  onLaunch() {
    this.initCloudBase();
    this.checkLoginStatus();
  },

  initCloudBase() {
    if (!wx.cloud) {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力');
    } else {
      wx.cloud.init({
        env: this.globalData.env,
        traceUser: true,
      });
    }
  },

  async checkLoginStatus() {
    try {
      const result = await wx.cloud.callFunction({
        name: 'login'
      });

      if (result.result.success) {
        const userData = result.result.data;
        this.globalData.userInfo = userData.user;
        this.globalData.petInfo = userData.pet;
        this.globalData.isLoggedIn = true;
        
        // 保存到本地存储
        wx.setStorageSync('userInfo', userData.user);
        wx.setStorageSync('petInfo', userData.pet);
        wx.setStorageSync('isLoggedIn', true);
      }
    } catch (error) {
      console.log('用户未登录或登录检查失败');
      this.globalData.isLoggedIn = false;
    }
  },

  // 全局登录方法
  requireLogin() {
    if (!this.globalData.isLoggedIn) {
      wx.navigateTo({
        url: '/pages/login/login'
      });
      return false;
    }
    return true;
  }
});
```

### 1.3 页面登录检查集成

#### 修改聊天页面
- [ ] **更新 chat.js 登录检查**
```javascript
// 在 onLoad 方法开始添加
onLoad() {
  const app = getApp();
  if (!app.requireLogin()) {
    return;
  }
  
  this.initChat();
  this.loadChatHistory();
},

// 修改 simulatePetReply 方法
simulateP etReply(userMessage) {
  this.setData({ isTyping: true });
  
  wx.cloud.callFunction({
    name: 'petChat',
    data: {
      message: userMessage
      // 移除硬编码的 petId
    },
    success: (res) => {
      this.setData({
        isTyping: false,
        isSending: false
      });
      
      if (res.result && res.result.success) {
        this.addMessage({
          type: 'pet',
          content: res.result.data.reply,
          time: this.formatTime(new Date()),
          liked: false
        });
        
        // 更新宠物状态
        const petStatus = res.result.data.pet_status;
        if (petStatus) {
          wx.setStorageSync('petInfo', petStatus);
        }
      } else {
        this.handleChatError(res.result.error);
      }
    },
    fail: (err) => {
      console.error('云函数调用失败:', err);
      this.handleChatError('网络连接失败');
    }
  });
},

handleChatError(errorMsg) {
  this.setData({
    isTyping: false,
    isSending: false
  });
  
  // 使用本地回复作为备选
  const fallbackReply = this.generatePetReply(this.data.inputText);
  this.addMessage({
    type: 'pet',
    content: fallbackReply,
    time: this.formatTime(new Date()),
    liked: false
  });
  
  wx.showToast({
    title: errorMsg,
    icon: 'none'
  });
}
```

---

## 💬 第二阶段：聊天历史功能实现

### 2.1 聊天历史加载

#### 修改 chat.js 的 loadChatHistory 方法
- [ ] **实现真实的聊天历史加载**
```javascript
// 加载聊天历史
async loadChatHistory() {
  try {
    wx.showLoading({ title: '加载聊天记录...' });
    
    const result = await wx.cloud.callFunction({
      name: 'petChat',
      data: {
        action: 'getChatHistory',
        limit: 50 // 最近50条消息
      }
    });
    
    if (result.result.success) {
      const chatHistory = result.result.data.map(record => ({
        id: record._id,
        type: record.sender_type === 'user' ? 'user' : 'pet',
        content: record.message,
        time: this.formatTime(new Date(record.timestamp)),
        liked: false
      }));
      
      this.setData({ messages: chatHistory });
      this.scrollToBottom();
    }
  } catch (error) {
    console.error('加载聊天历史失败:', error);
    // 使用本地缓存作为备选
    const localHistory = wx.getStorageSync('chatHistory') || [];
    this.setData({ messages: localHistory });
  } finally {
    wx.hideLoading();
  }
},

// 保存聊天记录到本地（备用）
saveChatHistory() {
  wx.setStorageSync('chatHistory', this.data.messages);
},

// 修改 addMessage 方法，同时保存到本地
addMessage(message) {
  const messages = [...this.data.messages];
  message.id = Date.now() + Math.random();
  messages.push(message);
  
  this.setData({ messages });
  this.saveChatHistory();
  this.scrollToBottom();
}
```

### 2.2 扩展 petChat 云函数

#### 修改 petChat/index.js
- [ ] **添加聊天历史查询功能**
```javascript
exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext();
  const openid = wxContext.OPENID;
  const { action, message, limit = 50 } = event;
  
  try {
    // 处理获取聊天历史的请求
    if (action === 'getChatHistory') {
      return await getChatHistory(openid, limit);
    }
    
    // 原有的聊天逻辑...
    return await handleChat(openid, message);
  } catch (error) {
    console.error('petChat云函数执行失败:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

// 获取聊天历史
async function getChatHistory(openid, limit) {
  const chatHistory = await db.collection('chat_context')
    .where({ user_id: openid })
    .orderBy('timestamp', 'desc')
    .limit(limit)
    .get();
    
  return {
    success: true,
    data: chatHistory.data.reverse() // 按时间正序排列
  };
}

// 处理聊天消息
async function handleChat(openid, message) {
  // 获取用户和宠物信息
  const userQuery = await db.collection('pet_users').where({
    user_id: openid
  }).get();
  
  const petQuery = await db.collection('pets').where({
    user_id: openid
  }).get();
  
  if (userQuery.data.length === 0 || petQuery.data.length === 0) {
    return {
      success: false,
      error: '用户或宠物信息不存在，请先完成登录'
    };
  }
  
  // 原有的聊天处理逻辑...
  // ...
}
```

---

## 📋 第三阶段：健康任务系统数据库集成

### 3.1 任务页面数据库集成

#### 修改 tasks.js
- [ ] **替换静态数据为数据库查询**
```javascript
Page({
  data: {
    currentCategory: 'all',
    todayCompleted: 0,
    weeklyCompleted: 0,
    totalExp: 0,
    todayTasks: [],
    weeklyTasks: [],
    loading: true
  },

  onLoad() {
    const app = getApp();
    if (!app.requireLogin()) {
      return;
    }
    this.loadTaskData();
  },

  onShow() {
    // 每次显示页面时刷新数据
    this.loadTaskData();
  },

  // 加载任务数据
  async loadTaskData() {
    try {
      wx.showLoading({ title: '加载任务数据...' });
      
      const result = await wx.cloud.callFunction({
        name: 'taskManager',
        data: {
          action: 'getUserTasks'
        }
      });
      
      if (result.result.success) {
        const data = result.result.data;
        this.setData({
          todayTasks: data.todayTasks,
          weeklyTasks: data.weeklyTasks,
          todayCompleted: data.todayCompleted,
          weeklyCompleted: data.weeklyCompleted,
          totalExp: data.totalExp,
          loading: false
        });
      } else {
        throw new Error(result.result.error);
      }
    } catch (error) {
      console.error('加载任务数据失败:', error);
      wx.showToast({
        title: '加载失败，请重试',
        icon: 'none'
      });
      this.setData({ loading: false });
    } finally {
      wx.hideLoading();
    }
  },

  // 完成任务
  async completeTask(e) {
    const taskId = e.currentTarget.dataset.id;
    const taskType = e.currentTarget.dataset.type;
    
    try {
      wx.showLoading({ title: '提交任务...' });
      
      const result = await wx.cloud.callFunction({
        name: 'taskManager',
        data: {
          action: 'completeTask',
          taskId: taskId,
          taskType: taskType
        }
      });
      
      if (result.result.success) {
        const data = result.result.data;
        
        // 显示奖励信息
        wx.showModal({
          title: '任务完成！',
          content: `获得 ${data.expReward} 经验值！`,
          showCancel: false,
          confirmText: '太棒了'
        });
        
        // 刷新任务数据
        this.loadTaskData();
        
        // 更新宠物信息
        if (data.petStatus) {
          wx.setStorageSync('petInfo', data.petStatus);
        }
      } else {
        throw new Error(result.result.error);
      }
    } catch (error) {
      console.error('完成任务失败:', error);
      wx.showToast({
        title: '提交失败，请重试',
        icon: 'none'
      });
    } finally {
      wx.hideLoading();
    }
  },

  // 开始计时任务
  async startTimerTask(e) {
    const taskId = e.currentTarget.dataset.id;
    
    // 实现计时器逻辑
    wx.showModal({
      title: '开始任务',
      content: '是否开始计时任务？',
      success: (res) => {
        if (res.confirm) {
          this.startTaskTimer(taskId);
        }
      }
    });
  },

  startTaskTimer(taskId) {
    // 实现具体的计时器逻辑
    // 可以跳转到专门的计时页面
    wx.navigateTo({
      url: `/pages/timer/timer?taskId=${taskId}`
    });
  }
});
```

### 3.2 扩展 taskManager 云函数

#### 修改 taskManager/index.js
- [ ] **实现完整的任务管理功能**
```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext();
  const openid = wxContext.OPENID;
  const { action, taskId, taskType, duration } = event;
  
  try {
    switch (action) {
      case 'getUserTasks':
        return await getUserTasks(openid);
      case 'completeTask':
        return await completeTask(openid, taskId, taskType, duration);
      case 'initDailyTasks':
        return await initDailyTasks(openid);
      default:
        return { success: false, error: '无效的操作类型' };
    }
  } catch (error) {
    console.error('taskManager云函数执行失败:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

// 获取用户任务
async function getUserTasks(openid) {
  const today = new Date().toISOString().split('T')[0];
  
  // 获取今日任务记录
  const todayRecords = await db.collection('task_records')
    .where({
      user_id: openid,
      date: today
    })
    .get();
  
  // 获取基础任务模板
  const taskTemplates = await db.collection('tasks').get();
  
  // 生成今日任务
  const todayTasks = taskTemplates.data
    .filter(task => task.type === 'daily')
    .map(task => {
      const record = todayRecords.data.find(r => r.task_id === task._id);
      return {
        ...task,
        completed: !!record,
        progress: record ? record.progress : 0
      };
    });
  
  // 获取周任务
  const weekStart = getWeekStart();
  const weekRecords = await db.collection('task_records')
    .where({
      user_id: openid,
      date: db.command.gte(weekStart)
    })
    .get();
  
  const weeklyTasks = taskTemplates.data
    .filter(task => task.type === 'weekly')
    .map(task => {
      const records = weekRecords.data.filter(r => r.task_id === task._id);
      const totalProgress = records.reduce((sum, r) => sum + (r.progress || 0), 0);
      return {
        ...task,
        currentProgress: totalProgress,
        completed: totalProgress >= task.target_progress
      };
    });
  
  // 计算统计数据
  const todayCompleted = todayTasks.filter(t => t.completed).length;
  const weeklyCompleted = weeklyTasks.filter(t => t.completed).length;
  
  // 获取用户总经验
  const userQuery = await db.collection('pet_users')
    .where({ user_id: openid })
    .get();
  const totalExp = userQuery.data[0]?.total_exp || 0;
  
  return {
    success: true,
    data: {
      todayTasks,
      weeklyTasks,
      todayCompleted,
      weeklyCompleted,
      totalExp
    }
  };
}

// 完成任务
async function completeTask(openid, taskId, taskType, duration = 0) {
  const today = new Date().toISOString().split('T')[0];
  
  // 获取任务信息
  const taskQuery = await db.collection('tasks').doc(taskId).get();
  if (!taskQuery.data) {
    throw new Error('任务不存在');
  }
  
  const task = taskQuery.data;
  
  // 检查是否已完成
  const existingRecord = await db.collection('task_records')
    .where({
      user_id: openid,
      task_id: taskId,
      date: today
    })
    .get();
  
  if (existingRecord.data.length > 0 && task.type === 'daily') {
    throw new Error('今日任务已完成');
  }
  
  // 创建任务记录
  const progress = taskType === 'timer' ? duration : 1;
  await db.collection('task_records').add({
    data: {
      user_id: openid,
      task_id: taskId,
      date: today,
      progress: progress,
      completed_at: new Date(),
      exp_reward: task.reward
    }
  });
  
  // 更新用户经验
  await db.collection('pet_users')
    .where({ user_id: openid })
    .update({
      data: {
        total_exp: db.command.inc(task.reward)
      }
    });
  
  // 更新宠物经验和亲密度
  const petUpdateResult = await db.collection('pets')
    .where({ user_id: openid })
    .update({
      data: {
        exp: db.command.inc(task.reward),
        intimacy: db.command.inc(Math.floor(task.reward / 5)),
        last_active: new Date()
      }
    });
  
  // 检查宠物是否升级
  const petQuery = await db.collection('pets')
    .where({ user_id: openid })
    .get();
  
  const pet = petQuery.data[0];
  const newLevel = Math.floor(pet.exp / 100) + 1;
  
  if (newLevel > pet.level) {
    await db.collection('pets')
      .doc(pet._id)
      .update({
        data: {
          level: newLevel,
          health: Math.min(pet.health + 10, 100),
          vitality: Math.min(pet.vitality + 10, 100)
        }
      });
  }
  
  // 返回更新后的宠物状态
  const updatedPet = await db.collection('pets')
    .where({ user_id: openid })
    .get();
  
  return {
    success: true,
    data: {
      expReward: task.reward,
      petStatus: updatedPet.data[0],
      levelUp: newLevel > pet.level
    }
  };
}

// 获取本周开始日期
function getWeekStart() {
  const now = new Date();
  const dayOfWeek = now.getDay();
  const diff = now.getDate() - dayOfWeek;
  const weekStart = new Date(now.setDate(diff));
  return weekStart.toISOString().split('T')[0];
}

// 初始化每日任务
async function initDailyTasks(openid) {
  // 这个函数在用户首次登录时调用
  // 可以预设一些基础任务
  const basicTasks = [
    {
      title: '晨间散步',
      description: '早晨散步30分钟，呼吸新鲜空气',
      category: 'exercise',
      type: 'daily',
      reward: 25,
      target_progress: 1
    },
    {
      title: '喝水提醒',
      description: '每2小时喝一杯水，保持身体水分',
      category: 'daily',
      type: 'daily',
      reward: 10,
      target_progress: 1
    }
    // 更多基础任务...
  ];
  
  // 检查任务是否已存在，如果不存在则创建
  for (const task of basicTasks) {
    const existing = await db.collection('tasks')
      .where({ title: task.title })
      .get();
    
    if (existing.data.length === 0) {
      await db.collection('tasks').add({ data: task });
    }
  }
  
  return { success: true };
}
```

---

## 🐾 第四阶段：宠物管理系统数据库集成

### 4.1 宠物主页数据库集成

#### 修改宠物主页相关文件
- [ ] **更新宠物主页数据加载**
```javascript
// 假设宠物主页在 pages/pet/pet.js
Page({
  data: {
    petInfo: null,
    loading: true,
    lastFeedTime: null,
    lastPlayTime: null,
    canFeed: true,
    canPlay: true
  },

  onLoad() {
    const app = getApp();
    if (!app.requireLogin()) {
      return;
    }
    this.loadPetData();
  },

  onShow() {
    this.loadPetData();
  },

  // 加载宠物数据
  async loadPetData() {
    try {
      wx.showLoading({ title: '加载宠物信息...' });
      
      const result = await wx.cloud.callFunction({
        name: 'petManager',
        data: {
          action: 'getPetStatus'
        }
      });
      
      if (result.result.success) {
        const petData = result.result.data;
        this.setData({
          petInfo: petData.pet,
          lastFeedTime: petData.lastFeedTime,
          lastPlayTime: petData.lastPlayTime,
          canFeed: petData.canFeed,
          canPlay: petData.canPlay,
          loading: false
        });
        
        // 更新本地存储
        wx.setStorageSync('petInfo', petData.pet);
      } else {
        throw new Error(result.result.error);
      }
    } catch (error) {
      console.error('加载宠物数据失败:', error);
      // 使用本地缓存数据
      const localPetInfo = wx.getStorageSync('petInfo');
      if (localPetInfo) {
        this.setData({ 
          petInfo: localPetInfo,
          loading: false 
        });
      }
    } finally {
      wx.hideLoading();
    }
  },

  // 喂食功能
  async feedPet() {
    if (!this.data.canFeed) {
      wx.showToast({
        title: '宠物还不饿哦',
        icon: 'none'
      });
      return;
    }
    
    try {
      wx.showLoading({ title: '喂食中...' });
      
      const result = await wx.cloud.callFunction({
        name: 'petManager',
        data: {
          action: 'feedPet'
        }
      });
      
      if (result.result.success) {
        const data = result.result.data;
        
        // 显示喂食效果
        wx.showModal({
          title: '喂食成功！',
          content: `宠物很开心！健康值 +${data.healthIncrease}`,
          showCancel: false
        });
        
        // 刷新宠物数据
        this.loadPetData();
        
        // 触发喂食动画
        this.playFeedAnimation();
      } else {
        throw new Error(result.result.error);
      }
    } catch (error) {
      console.error('喂食失败:', error);
      wx.showToast({
        title: '喂食失败，请重试',
        icon: 'none'
      });
    } finally {
      wx.hideLoading();
    }
  },

  // 互动功能
  async playWithPet() {
    if (!this.data.canPlay) {
      wx.showToast({
        title: '宠物需要休息一下',
        icon: 'none'
      });
      return;
    }
    
    try {
      wx.showLoading({ title: '互动中...' });
      
      const result = await wx.cloud.callFunction({
        name: 'petManager',
        data: {
          action: 'playWithPet'
        }
      });
      
      if (result.result.success) {
        const data = result.result.data;
        
        wx.showModal({
          title: '互动成功！',
          content: `宠物很快乐！亲密度 +${data.intimacyIncrease}`,
          showCancel: false
        });
        
        this.loadPetData();
        this.playInteractionAnimation();
      } else {
        throw new Error(result.result.error);
      }
    } catch (error) {
      console.error('互动失败:', error);
      wx.showToast({
        title: '互动失败，请重试',
        icon: 'none'
      });
    } finally {
      wx.hideLoading();
    }
  },

  // 播放喂食动画
  playFeedAnimation() {
    // 实现喂食动画效果
    this.setData({ showFeedEffect: true });
    setTimeout(() => {
      this.setData({ showFeedEffect: false });
    }, 2000);
  },

  // 播放互动动画
  playInteractionAnimation() {
    // 实现互动动画效果
    this.setData({ showPlayEffect: true });
    setTimeout(() => {
      this.setData({ showPlayEffect: false });
    }, 2000);
  }
});
```

### 4.2 扩展 petManager 云函数

#### 完善 petManager/index.js
- [ ] **实现完整的宠物管理功能**
```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext();
  const openid = wxContext.OPENID;
  const { action } = event;
  
  try {
    switch (action) {
      case 'getPetStatus':
        return await getPetStatus(openid);
      case 'feedPet':
        return await feedPet(openid);
      case 'playWithPet':
        return await playWithPet(openid);
      case 'updatePetStatus':
        return await updatePetStatus(openid, event.updates);
      default:
        return { success: false, error: '无效的操作类型' };
    }
  } catch (error) {
    console.error('petManager云函数执行失败:', error);
    return {
      success: false,
      error: error.message
    };
  }
};

// 获取宠物状态
async function getPetStatus(openid) {
  const petQuery = await db.collection('pets')
    .where({ user_id: openid })
    .get();
  
  if (petQuery.data.length === 0) {
    throw new Error('宠物信息不存在');
  }
  
  const pet = petQuery.data[0];
  
  // 获取最近的互动记录
  const today = new Date().toISOString().split('T')[0];
  const interactionQuery = await db.collection('pet_interactions')
    .where({
      user_id: openid,
      date: today
    })
    .orderBy('timestamp', 'desc')
    .get();
  
  // 计算冷却时间
  const now = Date.now();
  const feedCooldown = 2 * 60 * 60 * 1000; // 2小时
  const playCooldown = 1 * 60 * 60 * 1000; // 1小时
  
  let lastFeedTime = null;
  let lastPlayTime = null;
  let canFeed = true;
  let canPlay = true;
  
  for (const interaction of interactionQuery.data) {
    const interactionTime = new Date(interaction.timestamp).getTime();
    
    if (interaction.type === 'feed' && !lastFeedTime) {
      lastFeedTime = interaction.timestamp;
      canFeed = (now - interactionTime) > feedCooldown;
    }
    
    if (interaction.type === 'play' && !lastPlayTime) {
      lastPlayTime = interaction.timestamp;
      canPlay = (now - interactionTime) > playCooldown;
    }
  }
  
  // 自然衰减处理
  const updatedPet = await applyNaturalDecay(pet);
  
  return {
    success: true,
    data: {
      pet: updatedPet,
      lastFeedTime,
      lastPlayTime,
      canFeed,
      canPlay
    }
  };
}

// 喂食功能
async function feedPet(openid) {
  // 检查冷却时间
  const statusResult = await getPetStatus(openid);
  if (!statusResult.data.canFeed) {
    throw new Error('宠物还不饿，请稍后再喂食');
  }
  
  const pet = statusResult.data.pet;
  
  // 计算属性增加
  const healthIncrease = Math.min(15, 100 - pet.health);
  const intimacyIncrease = 3;
  
  // 更新宠物状态
  await db.collection('pets')
    .doc(pet._id)
    .update({
      data: {
        health: Math.min(pet.health + healthIncrease, 100),
        intimacy: Math.min(pet.intimacy + intimacyIncrease, 100),
        last_active: new Date()
      }
    });
  
  // 记录互动
  await db.collection('pet_interactions').add({
    data: {
      user_id: openid,
      pet_id: pet._id,
      type: 'feed',
      timestamp: new Date(),
      date: new Date().toISOString().split('T')[0],
      effect: {
        health: healthIncrease,
        intimacy: intimacyIncrease
      }
    }
  });
  
  return {
    success: true,
    data: {
      healthIncrease,
      intimacyIncrease
    }
  };
}

// 互动功能
async function playWithPet(openid) {
  const statusResult = await getPetStatus(openid);
  if (!statusResult.data.canPlay) {
    throw new Error('宠物需要休息，请稍后再互动');
  }
  
  const pet = statusResult.data.pet;
  
  const vitalityIncrease = Math.min(10, 100 - pet.vitality);
  const intimacyIncrease = 5;
  const expIncrease = 2;
  
  // 更新宠物状态
  await db.collection('pets')
    .doc(pet._id)
    .update({
      data: {
        vitality: Math.min(pet.vitality + vitalityIncrease, 100),
        intimacy: Math.min(pet.intimacy + intimacyIncrease, 100),
        exp: pet.exp + expIncrease,
        last_active: new Date()
      }
    });
  
  // 记录互动
  await db.collection('pet_interactions').add({
    data: {
      user_id: openid,
      pet_id: pet._id,
      type: 'play',
      timestamp: new Date(),
      date: new Date().toISOString().split('T')[0],
      effect: {
        vitality: vitalityIncrease,
        intimacy: intimacyIncrease,
        exp: expIncrease
      }
    }
  });
  
  // 检查是否升级
  const newLevel = Math.floor((pet.exp + expIncrease) / 100) + 1;
  if (newLevel > pet.level) {
    await db.collection('pets')
      .doc(pet._id)
      .update({
        data: {
          level: newLevel
        }
      });
  }
  
  return {
    success: true,
    data: {
      vitalityIncrease,
      intimacyIncrease,
      expIncrease,
      levelUp: newLevel > pet.level
    }
  };
}

// 自然衰减处理
async function applyNaturalDecay(pet) {
  const now = new Date();
  const lastActive = new Date(pet.last_active);
  const hoursSinceActive = (now - lastActive) / (1000 * 60 * 60);
  
  // 每小时衰减1点健康值和活力值
  const decayAmount = Math.floor(hoursSinceActive);
  
  if (decayAmount > 0) {
    const newHealth = Math.max(pet.health - decayAmount, 0);
    const newVitality = Math.max(pet.vitality - decayAmount, 0);
    
    if (newHealth !== pet.health || newVitality !== pet.vitality) {
      await db.collection('pets')
        .doc(pet._id)
        .update({
          data: {
            health: newHealth,
            vitality: newVitality
          }
        });
      
      return {
        ...pet,
        health: newHealth,
        vitality: newVitality
      };
    }
  }
  
  return pet;
}

// 更新宠物状态（通用方法）
async function updatePetStatus(openid, updates) {
  const petQuery = await db.collection('pets')
    .where({ user_id: openid })
    .get();
  
  if (petQuery.data.length === 0) {
    throw new Error('宠物信息不存在');
  }
  
  const pet = petQuery.data[0];
  
  await db.collection('pets')
    .doc(pet._id)
    .update({
      data: {
        ...updates,
        last_active: new Date()
      }
    });
  
  return {
    success: true,
    data: {
      message: '宠物状态更新成功'
    }
  };
}
```

---

## 🔧 第五阶段：数据库优化和监控

### 5.1 数据库索引优化

#### 在云开发控制台创建索引
- [ ] **为常用查询字段创建索引**
```javascript
// 在云开发控制台的数据库管理中创建以下索引：

// pet_users 集合
// 索引字段：user_id (升序)

// pets 集合  
// 索引字段：user_id (升序)

// chat_context 集合
// 复合索引：user_id (升序), timestamp (降序)

// task_records 集合
// 复合索引：user_id (升序), date (降序)
// 复合索引：user_id (升序), task_id (升序), date (降序)

// pet_interactions 集合
// 复合索引：user_id (升序), date (降序), timestamp (降序)
```

### 5.2 错误监控和日志

#### 创建通用错误处理模块
- [ ] **创建 utils/errorHandler.js**
```javascript
// miniprogram/utils/errorHandler.js
class ErrorHandler {
  static handleCloudFunctionError(error, functionName) {
    console.error(`云函数 ${functionName} 调用失败:`, error);
    
    // 记录错误到云数据库（可选）
    this.logError({
      type: 'cloud_function',
      function_name: functionName,
      error_message: error.message,
      timestamp: new Date()
    });
    
    // 返回用户友好的错误信息
    if (error.message.includes('网络')) {
      return '网络连接失败，请检查网络后重试';
    } else if (error.message.includes('权限')) {
      return '权限不足，请重新登录';
    } else {
      return '操作失败，请稍后重试';
    }
  }
  
  static async logError(errorInfo) {
    try {
      await wx.cloud.callFunction({
        name: 'logError',
        data: errorInfo
      });
    } catch (e) {
      console.error('记录错误日志失败:', e);
    }
  }
  
  static showUserFriendlyError(error, title = '操作失败') {
    const message = this.handleCloudFunctionError(error, 'unknown');
    wx.showModal({
      title,
      content: message,
      showCancel: false,
      confirmText: '我知道了'
    });
  }
}

module.exports = ErrorHandler;
```

### 5.3 性能监控

#### 创建性能监控云函数
- [ ] **创建 logError 云函数**
```javascript
// cloudfunctions/logError/index.js
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext();
  
  try {
    await db.collection('error_logs').add({
      data: {
        ...event,
        user_id: wxContext.OPENID,
        timestamp: new Date()
      }
    });
    
    return { success: true };
  } catch (error) {
    console.error('记录错误日志失败:', error);
    return { success: false, error: error.message };
  }
};
```

---

## 📊 第六阶段：数据分析和统计

### 6.1 用户行为分析

#### 创建数据分析云函数
- [ ] **创建 analytics 云函数**
```javascript
// cloudfunctions/analytics/index.js
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

exports.main = async (event, context) => {
  const { action, timeRange = 7 } = event;
  
  try {
    switch (action) {
      case 'getUserStats':
        return await getUserStats(timeRange);
      case 'getTaskStats':
        return await getTaskStats(timeRange);
      case 'getPetStats':
        return await getPetStats(timeRange);
      default:
        return { success: false, error: '无效的分析类型' };
    }
  } catch (error) {
    console.error('数据分析失败:', error);
    return { success: false, error: error.message };
  }
};

// 用户统计
async function getUserStats(days) {
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  
  // 活跃用户统计
  const activeUsers = await db.collection('pet_users')
    .where({
      last_login: db.command.gte(startDate)
    })
    .count();
  
  // 新用户统计
  const newUsers = await db.collection('pet_users')
    .where({
      join_date: db.command.gte(startDate)
    })
    .count();
  
  return {
    success: true,
    data: {
      activeUsers: activeUsers.total,
      newUsers: newUsers.total,
      timeRange: days
    }
  };
}

// 任务统计
async function getTaskStats(days) {
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  const startDateStr = startDate.toISOString().split('T')[0];
  
  // 任务完成统计
  const completedTasks = await db.collection('task_records')
    .where({
      date: db.command.gte(startDateStr)
    })
    .count();
  
  // 按类别统计
  const tasksByCategory = await db.collection('task_records')
    .aggregate()
    .match({
      date: db.command.gte(startDateStr)
    })
    .lookup({
      from: 'tasks',
      localField: 'task_id',
      foreignField: '_id',
      as: 'task_info'
    })
    .group({
      _id: '$task_info.category',
      count: db.command.sum(1)
    })
    .end();
  
  return {
    success: true,
    data: {
      totalCompleted: completedTasks.total,
      byCategory: tasksByCategory.list,
      timeRange: days
    }
  };
}

// 宠物统计
async function getPetStats(days) {
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  
  // 宠物互动统计
  const interactions = await db.collection('pet_interactions')
    .where({
      timestamp: db.command.gte(startDate)
    })
    .count();
  
  // 平均宠物等级
  const avgLevel = await db.collection('pets')
    .aggregate()
    .group({
      _id: null,
      avgLevel: db.command.avg('$level'),
      avgHealth: db.command.avg('$health'),
      avgIntimacy: db.command.avg('$intimacy')
    })
    .end();
  
  return {
    success: true,
    data: {
      totalInteractions: interactions.total,
      averageStats: avgLevel.list[0] || {},
      timeRange: days
    }
  };
}
```

---

## 🚀 部署和测试指南

### 部署步骤

1. **云函数部署**
```bash
# 在项目根目录执行
./deploy-cloudfunctions.sh
```

2. **数据库初始化**
```bash
# 运行数据库初始化
node call-init-database.js
```

3. **创建数据库索引**
   - 登录云开发控制台
   - 在数据库管理中为各集合创建索引

### 测试清单

- [ ] 用户登录功能测试
- [ ] 聊天历史加载测试
- [ ] 任务完成和奖励测试
- [ ] 宠物喂食和互动测试
- [ ] 数据同步测试
- [ ] 错误处理测试

### 监控指标

- 用户活跃度
- 任务完成率
- 宠物互动频率
- 云函数调用成功率
- 数据库查询性能

---

## 📝 注意事项

1. **数据安全**：确保所有用户数据查询都包含用户ID过滤
2. **性能优化**：合理使用数据库索引，避免全表扫描
3. **错误处理**：为所有云函数调用添加错误处理
4. **用户体验**：提供加载状态和友好的错误提示
5. **数据一致性**：使用事务处理关键操作

---

## 🔄 后续优化方向

1. **实时数据同步**：使用云开发的实时数据库功能
2. **离线支持**：实现离线数据缓存和同步
3. **推送通知**：添加任务提醒和宠物状态通知
4. **社交功能**：好友系统和排行榜
5. **AI增强**：更智能的任务推荐和宠物互动

---

*最后更新时间：2024年1月*