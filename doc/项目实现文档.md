# 健康宠物伴侣小程序 - 项目实现文档

## 项目概述

健康宠物伴侣是一款基于微信小程序的虚拟宠物健康管理应用，结合了云开发技术和AI智能助手功能。用户可以通过养成虚拟宠物的方式，培养健康的生活习惯，包括运动、饮水、睡眠等健康数据的记录和管理。

### 核心特性

- 🐾 **虚拟宠物养成**：通过完成健康任务来提升宠物等级和心情
- 📊 **健康数据管理**：记录和分析步数、饮水、睡眠、运动等健康数据
- ✅ **任务系统**：日常、每周、特殊任务的管理和完成
- 🤖 **AI智能助手**：基于AI的健康咨询和建议
- 🌍 **国际化支持**：支持简体中文、繁体中文、英文多语言
- 🎨 **主题切换**：支持浅色、深色、自动主题模式
- ☁️ **云端同步**：基于腾讯云开发的数据同步和存储

## 技术架构

### 前端架构

```
miniprogram/
├── app.js                 # 应用入口文件
├── app.json              # 应用配置文件
├── app.wxss              # 全局样式文件
├── pages/                # 页面目录
│   ├── home/             # 宠物主页
│   ├── tasks/            # 健康任务页面
│   ├── chat/             # AI聊天页面
│   ├── data/             # 健康数据页面
│   ├── profile/          # 个人设置页面
│   └── login/            # 登录页面
├── components/           # 自定义组件
├── utils/                # 工具函数
├── i18n/                 # 国际化语言包
└── images/               # 静态资源
```

### 后端架构（云函数）

```
cloudfunctions/
├── login/                # 用户登录认证
├── userManager/          # 用户信息管理
├── petManager/           # 宠物信息管理
├── taskManager/          # 任务管理
├── healthDataManager/    # 健康数据管理
├── petChat/              # AI聊天功能
├── analytics/            # 数据分析
└── initDatabase/         # 数据库初始化
```

### 数据库设计

#### 用户表 (users)
```javascript
{
  _id: ObjectId,
  openid: String,        // 微信用户唯一标识
  nickname: String,      // 用户昵称
  avatar: String,        // 头像URL
  signature: String,     // 个性签名
  level: Number,         // 用户等级
  experience: Number,    // 经验值
  totalDays: Number,     // 陪伴天数
  totalTasks: Number,    // 完成任务数
  settings: Object,      // 用户设置
  createTime: Date,      // 创建时间
  updateTime: Date       // 更新时间
}
```

#### 宠物表 (pets)
```javascript
{
  _id: ObjectId,
  userId: String,        // 用户ID
  name: String,          // 宠物名称
  type: String,          // 宠物类型
  level: Number,         // 宠物等级
  experience: Number,    // 经验值
  health: Number,        // 健康值
  happiness: Number,     // 快乐值
  energy: Number,        // 活力值
  mood: String,          // 心情状态
  avatar: String,        // 宠物头像
  createTime: Date,
  updateTime: Date
}
```

#### 健康数据表 (healthData)
```javascript
{
  _id: ObjectId,
  userId: String,        // 用户ID
  date: String,          // 日期 (YYYY-MM-DD)
  steps: Number,         // 步数
  water: Number,         // 饮水量 (ml)
  sleep: Number,         // 睡眠时长 (小时)
  exercise: Number,      // 运动时长 (分钟)
  createTime: Date,
  updateTime: Date
}
```

#### 任务表 (tasks)
```javascript
{
  _id: ObjectId,
  userId: String,        // 用户ID
  title: String,         // 任务标题
  description: String,   // 任务描述
  type: String,          // 任务类型 (daily/weekly/special)
  category: String,      // 任务分类
  status: String,        // 状态 (pending/completed)
  progress: Number,      // 进度
  target: Number,        // 目标值
  rewards: Object,       // 奖励 {exp, coins}
  dueDate: Date,         // 截止日期
  completedAt: Date,     // 完成时间
  createTime: Date,
  updateTime: Date
}
```

## 核心功能实现

### 1. 用户认证系统

#### 登录流程
1. 用户点击微信登录按钮
2. 调用 `wx.getUserProfile()` 获取用户信息
3. 调用 `wx.cloud.callFunction()` 执行登录云函数
4. 云函数验证用户身份并返回用户信息
5. 前端保存用户信息到本地缓存和全局数据

```javascript
// login.js 核心代码
async login() {
  try {
    const userProfile = await wx.getUserProfile({
      desc: '用于完善用户资料'
    });
    
    const loginResult = await wx.cloud.callFunction({
      name: 'login',
      data: {
        userInfo: userProfile.userInfo
      }
    });
    
    // 保存用户信息
    wx.setStorageSync('userInfo', loginResult.result.userInfo);
    getApp().globalData.userInfo = loginResult.result.userInfo;
    
    // 跳转到主页
    wx.switchTab({ url: '/pages/home/home' });
  } catch (error) {
    console.error('登录失败:', error);
  }
}
```

### 2. 国际化系统

#### 架构设计
- **语言包管理**：`i18n/` 目录下存放各语言的配置文件
- **动态加载**：根据用户设置动态加载对应语言包
- **全局管理**：通过 `i18n.js` 工具类统一管理

#### 实现步骤
1. 创建语言包文件（zh-cn.js, zh-tw.js, en.js）
2. 实现 i18n 工具类
3. 在页面中集成国际化支持
4. 替换硬编码文本为国际化变量

```javascript
// i18n/index.js
class I18n {
  constructor() {
    this.currentLanguage = 'zh-cn';
    this.texts = {};
    this.loadLanguage(this.currentLanguage);
  }
  
  loadLanguage(language) {
    try {
      this.texts = require(`./${language}.js`);
      this.currentLanguage = language;
    } catch (error) {
      console.error('语言包加载失败:', error);
    }
  }
  
  getText(key, params = {}) {
    const keys = key.split('.');
    let text = this.texts;
    
    for (const k of keys) {
      text = text[k];
      if (!text) return key;
    }
    
    // 参数替换
    return this.replaceParams(text, params);
  }
}
```

### 3. 主题系统

#### 主题管理
- **主题模式**：浅色、深色、自动（跟随系统）
- **动态切换**：实时切换主题无需重启
- **持久化**：主题设置保存到本地缓存

```javascript
// utils/themeManager.js
class ThemeManager {
  constructor() {
    this.currentTheme = 'auto';
    this.isDarkMode = false;
    this.init();
  }
  
  init() {
    const savedTheme = wx.getStorageSync('theme') || 'auto';
    this.setTheme(savedTheme);
  }
  
  setTheme(theme) {
    this.currentTheme = theme;
    
    if (theme === 'auto') {
      // 获取系统主题
      const systemInfo = wx.getSystemInfoSync();
      this.isDarkMode = systemInfo.theme === 'dark';
    } else {
      this.isDarkMode = theme === 'dark';
    }
    
    // 保存设置
    wx.setStorageSync('theme', theme);
    
    // 通知页面更新
    this.notifyThemeChange();
  }
}
```

### 4. 虚拟宠物系统

#### 宠物状态管理
- **属性系统**：健康值、快乐值、活力值、经验值
- **心情状态**：根据属性值计算宠物心情
- **等级系统**：经验值达到阈值自动升级

```javascript
// 宠物心情计算
calculatePetMood(health, happiness, energy) {
  const average = (health + happiness + energy) / 3;
  
  if (average >= 80) return 'veryHappy';
  if (average >= 60) return 'happy';
  if (average >= 40) return 'normal';
  return 'needCare';
}

// 经验值和等级计算
calculateLevel(experience) {
  return Math.floor(experience / 100) + 1;
}
```

### 5. 健康数据管理

#### 数据收集
- **微信运动数据**：通过 `wx.getWeRunData()` 获取步数
- **手动输入**：用户手动记录饮水、睡眠、运动数据
- **数据验证**：确保数据的合理性和准确性

#### 数据分析
- **趋势分析**：计算日、周、月数据趋势
- **健康建议**：基于数据提供个性化建议
- **可视化展示**：图表展示数据变化

```javascript
// 获取微信运动数据
async getWeRunData() {
  try {
    const result = await wx.getWeRunData();
    const decryptResult = await wx.cloud.callFunction({
      name: 'decryptWeRunData',
      data: {
        encryptedData: result.encryptedData,
        iv: result.iv
      }
    });
    
    return decryptResult.result.stepInfoList;
  } catch (error) {
    console.error('获取运动数据失败:', error);
    return [];
  }
}
```

### 6. 任务系统

#### 任务类型
- **日常任务**：每日重置的基础任务
- **每周任务**：每周重置的进阶任务
- **特殊任务**：限时或成就类任务

#### 任务管理
- **自动生成**：系统自动为用户生成个性化任务
- **进度跟踪**：实时跟踪任务完成进度
- **奖励发放**：完成任务自动发放经验和金币奖励

```javascript
// 任务完成逻辑
async completeTask(taskId) {
  try {
    const result = await wx.cloud.callFunction({
      name: 'taskManager',
      data: {
        action: 'complete',
        taskId: taskId
      }
    });
    
    if (result.result.success) {
      // 更新宠物经验
      this.updatePetExperience(result.result.rewards.exp);
      
      // 显示奖励提示
      this.showRewardToast(result.result.rewards);
    }
  } catch (error) {
    console.error('完成任务失败:', error);
  }
}
```

### 7. AI聊天系统

#### 智能对话
- **上下文理解**：维护对话上下文
- **健康咨询**：提供专业的健康建议
- **个性化回复**：基于用户数据个性化回复

```javascript
// AI聊天实现
async sendMessage(message) {
  try {
    const result = await wx.cloud.callFunction({
      name: 'petChat',
      data: {
        message: message,
        context: this.data.chatHistory,
        userProfile: getApp().globalData.userInfo
      }
    });
    
    return result.result.reply;
  } catch (error) {
    console.error('发送消息失败:', error);
    return '抱歉，我现在无法回复，请稍后再试。';
  }
}
```

## 部署和运维

### 云开发配置

1. **环境初始化**
```javascript
// app.js
wx.cloud.init({
  env: 'your-env-id',
  traceUser: true
});
```

2. **数据库权限配置**
```json
{
  "read": "auth != null",
  "write": "auth != null && auth.openid == resource.userId"
}
```

3. **云函数部署**
```bash
# 部署所有云函数
npm run deploy:functions

# 部署单个云函数
npm run deploy:function -- login
```

### 性能优化

1. **代码分包**：使用小程序分包加载减少首次加载时间
2. **图片优化**：使用 WebP 格式和适当的压缩比例
3. **缓存策略**：合理使用本地缓存减少网络请求
4. **懒加载**：非关键资源延迟加载

### 监控和日志

1. **错误监控**：集成错误日志收集
2. **性能监控**：监控页面加载时间和用户操作响应时间
3. **用户行为分析**：收集用户使用数据用于产品优化

## 开发规范

### 代码规范

1. **命名规范**
   - 文件名：小写字母，单词间用连字符分隔
   - 变量名：驼峰命名法
   - 常量名：全大写，单词间用下划线分隔

2. **注释规范**
   - 函数必须有注释说明功能、参数、返回值
   - 复杂逻辑必须有行内注释
   - 文件头部必须有文件说明注释

3. **代码结构**
   - 单个函数不超过50行
   - 单个文件不超过500行
   - 合理使用模块化和组件化

### Git 工作流

1. **分支管理**
   - `main`：主分支，用于生产环境
   - `develop`：开发分支，用于集成测试
   - `feature/*`：功能分支，用于新功能开发
   - `hotfix/*`：热修复分支，用于紧急修复

2. **提交规范**
   - `feat: 新功能`
   - `fix: 修复bug`
   - `docs: 文档更新`
   - `style: 代码格式调整`
   - `refactor: 代码重构`
   - `test: 测试相关`

## 总结

健康宠物伴侣小程序是一个功能完整、架构清晰的现代化小程序应用。通过虚拟宠物养成的游戏化方式，有效激励用户养成健康的生活习惯。项目采用了云开发技术栈，实现了前后端一体化开发，大大提高了开发效率。

### 技术亮点

1. **完整的国际化支持**：支持多语言切换，面向全球用户
2. **智能主题系统**：支持多种主题模式，提升用户体验
3. **AI智能助手**：集成AI技术，提供个性化健康建议
4. **云端数据同步**：基于腾讯云开发，数据安全可靠
5. **游戏化设计**：通过虚拟宠物养成，提高用户粘性

### 未来规划

1. **社交功能**：添加好友系统和排行榜
2. **更多数据源**：集成更多健康设备数据
3. **AI能力增强**：提供更智能的健康分析和建议
4. **小程序生态**：开发配套的管理后台和数据分析平台

这个项目展示了现代小程序开发的最佳实践，为类似项目的开发提供了很好的参考价值。