# 健康数据修复部署指南

## 问题描述
用户反馈 `health_data` 表存在以下问题：
1. 写入了大量重复数据
2. 缺少饮水(water_ml)、睡眠(sleep_hours)、运动(exercise_minutes)字段
3. 需要每天只生成一条记录，更新表中数据即可

## 修复内容

### 1. 云函数修复
已修复 `healthDataManager/index.js` 中的以下问题：
- ✅ 修复 `upsertHealthData` 函数，确保每天只有一条记录
- ✅ 添加缺失的健康数据字段：`water_ml`、`sleep_hours`、`exercise_minutes`
- ✅ 修复数据更新逻辑，保留原有数据避免覆盖
- ✅ 修复 `inputHealthData` 函数返回数据结构

### 2. 前端修复
已修复 `miniprogram/pages/data/data.js` 中的数据处理逻辑：
- ✅ 确保正确处理新的健康数据字段名
- ✅ 更新数据统计和显示逻辑

### 3. 超时配置
已为所有云函数配置合适的超时时间：
- `healthDataManager`: 15秒
- `taskManager`: 12秒
- `petManager`: 12秒
- `login`: 10秒
- `userManager`: 10秒
- `initDatabase`: 30秒
- 其他云函数: 8-20秒

## 部署步骤

### 第一步：部署云函数
1. 打开微信开发者工具
2. 右键点击 `cloudfunctions/healthDataManager` 文件夹
3. 选择「上传并部署：云端安装依赖」
4. 等待部署完成

### 第二步：清理重复数据
1. 在微信开发者工具的云开发控制台中
2. 进入数据库管理
3. 找到 `health_data` 集合
4. 手动删除重复记录，保留每个用户每天最新的一条记录

或者使用云函数清理：
1. 在云开发控制台的云函数管理中
2. 找到 `healthDataManager` 云函数
3. 点击「测试」，输入以下参数：
```json
{
  "action": "cleanAllDuplicates"
}
```
4. 点击「测试」执行清理

### 第三步：测试功能
1. 在小程序中进入健康数据页面
2. 尝试编辑饮水量、睡眠时长、运动时长
3. 检查数据是否正确保存
4. 验证每天只有一条记录

## 验证步骤

### 1. 检查数据结构
在云开发控制台数据库中查看 `health_data` 集合，确认记录包含以下字段：
```json
{
  "_id": "记录ID",
  "user_id": "用户ID",
  "date": "2025-07-27",
  "steps": 8000,
  "water_ml": 1500,
  "sleep_hours": 7.5,
  "exercise_minutes": 30,
  "calories": 320,
  "weight": 65.5,
  "source": "manual",
  "created_at": "创建时间",
  "updated_at": "更新时间"
}
```

### 2. 测试数据录入
在小程序健康数据页面：
1. 点击饮水量编辑按钮，输入新数值
2. 点击睡眠时长编辑按钮，输入新数值
3. 点击运动时长编辑按钮，输入新数值
4. 检查数据是否正确更新

### 3. 验证唯一性
1. 多次编辑同一天的数据
2. 在数据库中确认该用户该日期只有一条记录
3. 确认记录被正确更新而不是新增

## 问题排查

### 如果数据仍然重复
1. 检查 `upsertHealthData` 函数是否正确部署
2. 确认查询条件 `user_id` 和 `date` 是否正确
3. 检查云函数日志是否有错误信息

### 如果字段缺失
1. 确认云函数代码中包含所有必要字段
2. 检查前端传递的参数是否正确
3. 验证数据库写入逻辑

### 如果超时问题仍存在
1. 检查云函数配置是否正确部署
2. 考虑增加超时时间
3. 优化数据库查询性能

## 注意事项

1. **数据备份**：在清理重复数据前，建议先备份数据库
2. **渐进部署**：建议先在测试环境验证，再部署到生产环境
3. **用户通知**：如果需要清理大量数据，建议提前通知用户
4. **监控日志**：部署后密切关注云函数执行日志

## 预期效果

修复完成后：
- ✅ 每个用户每天只有一条健康数据记录
- ✅ 包含完整的健康数据字段（饮水、睡眠、运动等）
- ✅ 数据更新而不是重复创建
- ✅ 云函数执行不再超时
- ✅ 前端正确显示所有健康数据