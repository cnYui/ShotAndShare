# 健康养宠小程序架构设计

## 前端架构设计

微信小程序前端采用 TabBar 导航（底部菜单）设计，包含 5 个主要页面:

- 宠物主页面
- 健康任务页面  
- 宠物互动聊天页面
- 健康数据页面
- 设置/个人页面

用户可以通过底部菜单在各页面之间快速切换。页面设计遵循以下原则:

- 简洁直观的界面布局
- 突出展示虚拟宠物形象
- 清晰呈现用户健康数据
- 良好的交互体验

下面将详细介绍各页面的具体内容及功能实现。

### 宠物主页面

- **视觉布局与主要元素**：宠物主页面是应用首页，顶部显示虚拟宠物的形象（动画模型或图片），旁边展示宠物昵称和等级。宠物形象下方以卡片或进度条形式显示宠物的关键状态值：例如健康值、活力值、亲密度等。页面中部显示宠物当前的成长进度（如经验条）和状态描述（如"开心"或"疲劳"），底部区域提供主要交互按钮（如去完成任务、喂食宠物等）。整体配色温馨，宠物形象会根据状态不同切换表情或动作，以反馈用户行为。

- **页面导航关系**：作为首页，主页面通过底部Tab或按钮链接导航至其他页面。例如，"健康任务"按钮进入任务页面，"聊天"按钮进入宠物聊天页面；顶部可能有一个统计图标可跳转到健康数据页面。TabBar菜单中，主页面对应第一个Tab，用户可随时点返回主页面。页面间采用小程序的`navigateTo`或`switchTab`实现跳转，保证用户能方便返回主页面。

- **用户交互**：用户进入主页面时，宠物形象会动态更新（如挥手迎接），并根据用户近期健康完成情况调整表情（例如用户任务达标时宠物开心，未达标时露出鼓励表情）。用户可以点击宠物形象触发动画效果（如抚摸宠物，宠物做出反应），点击状态栏的某个状态值（如健康值）可以弹出提示解释状态含义。主页面鼓励用户与宠物互动，例如宠物可能会动态显示一句问候或提示去完成任务。用户下拉页面可刷新宠物状态数据。

### 健康任务页面

#### 视觉布局与主要元素

- 健康任务页面以列表或卡片形式列出每日健康任务，例如"今日步数达到目标"、"进行一次运动训练"、"摄入蔬菜水果"等
- 每个任务项包括:
  - 任务名称
  - 简单说明
  - 进度或状态（已完成/未完成）
  - 对应的奖励（如经验值）
- 可使用圆形进度条或勾选框指示任务完成情况
- 页面顶部显示当天日期和总体完成进度
- 为了激励用户，可在列表顶部加入每日小目标或奖励概览

#### 页面导航关系

- 健康任务页通常作为底部Tab之一，方便用户每日查看任务
- 主页面会有入口按钮链接到任务页
- 任务页内的某些任务项若需要输入数据或查看详情（例如记录饮食），可以导航到子页面或弹出浮层
- 完成任务后，可提供按钮返回主页面或继续完成其他任务
- 导航结构保持简单：Tab切换返回主页面，或通过导航栏返回

#### 用户交互

- 用户可以勾选或标记任务完成
- 对于系统可自动获取的数据（如步数），应用会在用户授权后自动更新任务状态
- 当检测到用户步数已达标，任务项会自动显示"已完成"并给予动画提示奖励
- 对于需用户手动确认的任务（如饮食任务）:
  - 用户点击任务卡片上的"完成"按钮
  - 会弹出确认或简单表单（如输入今日饮水量）
  - 然后标记任务完成
- 任务完成时:
  - 宠物会给予文字或表情正向反馈（如"小宠物为你鼓掌！"）
  - 同时触发奖励计算（经验值增加，影响宠物成长）
- 用户可以:
  - 下拉刷新任务列表数据
  - 点击刷新按钮同步当天最新的步数和运动数据

### 宠物互动聊天页面

#### 视觉布局与主要元素

- 宠物聊天页面提供与虚拟宠物对话的界面
- 页面整体类似聊天应用，对话气泡从上下排列
- 屏幕下方是一个输入区域:
  - 包括文本输入框
  - "发送"按钮
- 对话区显示:
  - 宠物回复以特殊样式显示（带有宠物头像的气泡）
  - 用户提问以用户头像气泡显示
- 页面顶部显示:
  - 宠物头像
  - 宠物名称
- 可能包括快捷提问按钮:
  - "今天我的健康如何？"
  - "有什么健身建议？"
- 界面风格可爱友好，让用户感觉在和宠物交谈

#### 页面导航关系

- 聊天页是底部Tab之一，用户可随时进入与宠物交流
- 用户在其他页面（如主页面）点击与宠物对话的按钮也会跳转到聊天页
- 聊天页面内部一般不再跳转到别的页面，以保持对话连续性
- 可能提供查看聊天说明或隐私政策的链接（通过navigateTo打开新页面）
- 用户通过Tab或返回按钮可回到主页面或其他主要页面

#### 用户交互

- 用户可以在输入框输入任意问题或消息
- 点击"发送"后:
  - 小程序调用后端AI服务获取宠物回答
  - 将回复显示在对话窗口
- 发送后显示"宠物正在思考…"的加载动画
- 对话是多轮的:
  - 用户可以连续提问
  - 宠物根据上下文连续回答
- 交互细节:
  - 长按某条对话可复制文本或删除
  - 向上滑动可以查看历史对话记录
- 聊天回答:
  - 尽量自然、有个性
  - 宠物用第一人称和表情符号回应
  - 让对话更加生动

### 健康数据页面

#### 视觉布局与主要元素

- 健康数据页用于展示用户的各项历史健康指标
- 页面上部:
  - 放置折线图、柱状图等数据可视化图表
  - 显示最近一段时间的每日步数、消耗卡路里、运动时长等趋势
- 下方以分类模块显示不同数据项:
  - 步数记录
  - 任务完成率
  - 体重/BMI变化（如果有手动记录）
  - 睡眠/心率（如有接入其他数据）
- 每个模块以卡片形式呈现:
  - 内含关键数字
  - 简短分析（例如"本周平均每日步数9000步，超过上周"）
- 如果仅获取微信步数数据:
  - 重点展示步数相关信息
  - 包括当月每日步数列表和总计步数

#### 页面导航关系

- 健康数据页可通过底部Tab进入
- 也可能从宠物主页面点击某个数据概览卡跳转而来
- 页面内部可能提供切换不同数据类型的子栏:
  - 通过选项卡
  - 或下拉菜单
- 用户查看完数据，可直接使用Tab回到主页面或其他页

#### 用户交互

- 用户可以:
  - 切换数据的统计周期（日、周、月）查看不同时间范围的趋势图
  - 通过左右滑动图表区域，查看更长时间前的数据
  - 手动输入或纠正数据（例如体重记录）
- 下拉页面时:
  - 应用会尝试同步最新健康数据
  - 包括调用微信运动API获取最新步数
- 用户授权微信运动步数后:
  - 后端通过wx.getWeRunData()接口获取最近30天步数并解密
  - 每次用户打开数据页或主动刷新时，可更新当天步数
- 若未授权:
  - 相关区域会提示用户授权获取微信步数
- 历史任务完成情况板块:
  - 汇总用户每天完成任务的数量或达成率
  - 可点击某天查看详细任务完成列表
- 整体交互以查看为主，确保图表滚动和触摸悬停显示数值等体验流畅

### 设置/个人页面

#### 视觉布局与主要元素

- 设置页（个人中心页）主要显示:
  - 用户个人信息
  - 应用设置项
- 页面顶部:
  - 用户头像和昵称（从微信获取）
- 下方列出多个功能项的列表:
  - "我的信息"（编辑宠物或个人资料）
  - "微信健康数据授权"
  - "通知设置"
  - "关于我们"
  - "帮助与反馈"等
- 每一项右侧通常有箭头，表示可点击进入详情或开关
- 页面底部可能有:
  - 退出登录
  - 版本信息等小字提示
- 整体设计风格简洁，列表项清晰分隔

#### 页面导航关系

- 设置页通过底部最后一个Tab进入（通常是"我的"或个人中心图标）
- 可跳转到多个子页面:
  - "我的信息"进入子页面编辑宠物名称或选择宠物形象
  - "微信健康数据授权"调用微信授权弹窗或指引
  - "帮助与反馈"进入FAQ或意见反馈表单页面
- 这些子页面在完成操作后可navigateBack返回设置页
- 设置页本身主要是各项配置的入口，不涉及进一步页面间跳转除非进入上述子项

#### 用户交互

- 用户可以:
  - 查看和修改个人资料（如修改宠物的名字头像）
  - 点击"授权微信健康数据"时:
    - 应用调用wx.authorize({scope: 'scope.werun'})
    - 请求获取微信运动步数权限
  - 打开/关闭某些开关，如消息通知
- "关于"或"帮助"提供静态信息，无特别交互
- 所有更改如头像昵称修改、权限授权，都会实时同步到后台数据库
- 整个设置过程强调确认和反馈:
  - 每次修改完毕给予toast提示"已保存"
  - 敏感操作（如退出登录）使用二次确认弹窗避免误触

### 后端架构设计

后端采用腾讯云提供的基础设施，包括云数据库和云函数/服务器支持。其中数据库可以使用MongoDB（如小程序云开发的文档型数据库）或MySQL（如腾讯云CynosDB），存储各类业务数据，每个用户的数据通过唯一标识（如openid）进行隔离存储。后端同时负责与大语言模型的对接服务，用于宠物聊天功能。下面详细说明数据库表结构设计和大模型接入方案。

#### 数据库结构设计

结合业务需要，设计以下核心数据表：

##### 用户表（User）
存储用户基础信息。字段包括：
- user_id（主键，用户唯一ID，用微信openid标识）
- nickname（昵称）
- avatar_url（头像URL）
- gender（性别，可选）
- city（城市，可选）
- join_date（注册日期）等

用途：识别用户、展示个人信息和关联其宠物

##### 宠物表（Pet）
存储每个用户所养宠物的状态和属性。字段示例：
- pet_id（主键，自增或UUID）
- user_id（外键，关联User表）
- pet_name（宠物名字，由用户设置）
- species（宠物类型，例如"狗"或"猫"）
- level（等级）
- exp（当前经验值）
- health（健康值）
- vitality（活力值）
- intimacy（亲密度）
- last_active（最后一次互动时间）等

用途：记录宠物的成长状态和用户互动数据

##### 任务定义表（Task）
预定义所有健康任务类型。字段包括：
- task_id（主键）
- name（任务名称，如"步数达到1万步"）
- category（类别，例如步数/运动/饮食）
- target_value（任务目标值，例如10000步）
- unit（单位，如"步"）
- reward_exp（完成任务可获得的经验值奖励）
- reward_item（其他奖励，如宠物币或道具，可选）等

用途：定义任务规则，便于后续调整或增加新任务

##### 每日任务记录表（TaskRecord）
记录每个用户每天的任务完成情况。字段示例：
- record_id（主键）
- user_id
- date（日期）
- task_id
- status（状态：未完成/已完成）
- progress（进度，如当前步数值）等

用途：用于判断任务是否完成、计算连续完成天数等

##### 健康数据表（HealthData）
保存用户各项健康指标的历史记录。字段如：
- data_id
- user_id
- date
- steps（步数）
- calories（卡路里消耗）
- exercise_minutes（运动时长）
- weight（体重，如用户手动记录）等

用途：持久化每日步数等数据

##### （可选）聊天上下文表（ChatContext）
如果需要持久保存聊天记录或上下文，可以设计此表。字段：
- chat_id
- user_id
- timestamp
- role（值为"user"或"pet"）
- message（消息内容）等

用途：存储用户与宠物的对话内容，用于多轮对话时提供上下文记忆

#### 数据库实现与权限

如果使用微信小程序云开发：
- 数据表相当于云数据库的集合
- user_id（openid）可用来划分每个用户的数据作用域
- 在小程序端调用云数据库时，可以利用条件只查询user_id == openid的数据
- 确保用户只能访问自己的记录
- 利用云开发的权限设置，只允许拥有有效登录态的用户读写自己的记录
- 对于较复杂的查询（如统计所有任务完成率），可通过云函数来汇总计算

#### 大语言模型接入设计

宠物聊天功能由大语言模型（LLM）提供智能对话支持。考虑到微信小程序无法直接调用外部互联网API的限制，后端将通过云函数或独立服务器充当中间层，实现与OpenAI或其它模型接口的通信。

##### 1. 模型选择与配置

可选用的模型包括：
- OpenAI GPT系列（如GPT-3.5/GPT-4）
- 腾讯云自研的混元大模型API
- Moonshot AI提供的对话模型等

开发者需要：
- 获取相应模型的API密钥或调用凭证
- 在后端安全存储
- 对于OpenAI，在其平台申请API Key
- 对于腾讯云模型，在云开发控制台配置好模型Token

安全考虑：
- API密钥绝不能暴露在前端
- 小程序前端不直接存储或调用模型接口
- 所有调用通过后端完成

##### 2. 后端接口实现

在腾讯云云函数或自己的服务器上实现HTTP服务接口（例如/chat接口）：

接收内容包含：
- 用户ID（用于识别用户/宠物）
- 用户提问文本
- 必要的上下文信息（聊天历史、宠物当前状态等）

提示构造：
- 设置系统提示（System Prompt）扮演宠物人格
- 附加当前宠物状态或用户健康数据
- 将用户的问题作为用户消息发送给模型服务

##### 3. 模型请求与响应

后端通过HTTP请求将内容发送至大模型服务：
- 调用OpenAI的/v1/chat/completions接口
- 或腾讯云的ChatCompletions接口
- 解析返回的JSON，提取模型生成的回复文本
- 处理错误或超时情况

##### 4. 将回复返回小程序

后端处理：
- 构造简洁的JSON响应
- 包括宠物的回答文本
- 可能的其他元数据

前端处理：
- 停止显示"思考中"状态
- 将宠物的回复气泡加入聊天界面

##### 5. 对话上下文维护

为保持对话连贯性：
- 维护一定长度的上下文记忆
- 每次调用模型API时附上最近几轮问答
- 可存在服务器内存、缓存，或数据库
- 支持最多40条上下文消息
- 可选择保留最近3-5轮对话上下文

##### 6. 多模型/服务支持

后端封装统一接口：
- 根据配置选择实际调用的模型服务
- 提供参数model_provider（"OpenAI"/"Tencent"/"Moonshot"）
- 使用腾讯云云函数直接访问外部HTTP
- 或使用腾讯云AnyService/HTTP API代理转发

##### 7. 性能与费用考虑

性能优化：
- 对同一用户的连续请求做队列
- 可选启用流式响应
- 做请求频率限制
- 记录请求内容长度、耗时

##### 8. 内容安全过滤

内容审核：
- 使用Tencent云内容安全API
- 或模型自带的moderation功能
- 对不适当内容进行替换或过滤

### 宠物成长逻辑

虚拟宠物将随着用户完成健康任务而成长，这是激励用户坚持健康生活的核心玩法。

#### 经验值与升级机制

每完成健康任务获得经验值（EXP）奖励：
- 简单饮水任务：5经验
- 大的运动目标：20经验

等级提升机制：
- 经验值累积到阈值时提升等级
- 等级提升所需经验逐级递增
- 1级升2级：100经验
- 2级升3级：150经验

升级奖励：
- 触发升级动画或特效
- 系统提示祝贺
- 每提升5级解锁新形态或技能

#### 宠物形态与技能解锁

形态变化：
- 1级：幼年体型
- 5级：少年形态
- 10级：成年
- 20级：特殊形态

技能解锁：
- 新的动作（握手、后空翻等）
- 新的对话风格
- 更丰富的表情包语言

#### 状态值动态变化

##### 健康值（Health）
影响因素：
- 用户完成健康任务情况
- 连续达到步数目标
- 均衡饮食

变化规则：
- 每日基础下降1点
- 完成所有任务则增加上限
- 不完成则跌落

##### 活力值（Vitality）
影响因素：
- 用户当日运动量
- 步数达标情况

计算方式：
- 10000步：100%活力
- 5000步：50%活力

##### 亲密度（Intimacy）
增加途径：
- 每日首次登录
- 和宠物聊天
- 完成任务

计算规则：
- 每互动一次加1点
- 上限100点
- 长时间未互动会下降

#### 任务与状态的关联

完成不同类型任务的影响：

步数/运动类任务：
- 增加活力值（+20%）
- 小幅提高健康值

饮食/睡眠类任务：
- 提高健康值
- 略微影响活力

聊天互动任务：
- 主要增加亲密度

连续完成奖励：
- 连续7天全勤
- 获得额外经验
- 健康值大幅提升
- 宠物形象出现光环特效

#### 负反馈和引导

未完成任务时：
- 不惩罚用户
- 通过状态变化和对话引导
- 健康值下降时给予提示
- 正向激励为主
- 负向提醒为辅

#### 数据同步与计算

后端处理：
- 每天更新宠物状态值和经验
- 可立即更新或定时更新
- 凌晨计算前一天数据
- 更新健康值
- 持久化宠物状态到Pet表
- 任务记录变更时触发云函数
- 经验值和等级即时更新
