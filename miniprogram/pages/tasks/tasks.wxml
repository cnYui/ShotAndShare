<!--å¥åº·ä»»åŠ¡é¡µé¢-->
<view class="tasks-container">
  <!-- é¡¶éƒ¨ç»Ÿè®¡åŒºåŸŸ -->
  <view class="stats-section">
    <view class="stats-card">
      <view class="stat-item">
        <text class="stat-number">{{todayCompleted}}</text>
        <text class="stat-label">{{texts.tasks.todayCompleted}}</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-number">{{weeklyCompleted}}</text>
        <text class="stat-label">{{texts.tasks.weeklyCompleted}}</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-number">{{totalExp}}</text>
        <text class="stat-label">{{texts.tasks.totalExp}}</text>
      </view>
    </view>
  </view>

  <!-- ä»»åŠ¡åˆ†ç±»æ ‡ç­¾ -->
  <view class="category-tabs">
    <view class="tab-item {{currentCategory === 'all' ? 'active' : ''}}" 
          bindtap="switchCategory" data-category="all">
      <text>{{texts.tasks.categories.all}}</text>
    </view>
    <view class="tab-item {{currentCategory === 'daily' ? 'active' : ''}}" 
          bindtap="switchCategory" data-category="daily">
      <text>{{texts.tasks.categories.daily}}</text>
    </view>
    <view class="tab-item {{currentCategory === 'exercise' ? 'active' : ''}}" 
          bindtap="switchCategory" data-category="exercise">
      <text>{{texts.tasks.categories.exercise}}</text>
    </view>
    <view class="tab-item {{currentCategory === 'diet' ? 'active' : ''}}" 
          bindtap="switchCategory" data-category="diet">
      <text>{{texts.tasks.categories.diet}}</text>
    </view>
    <view class="tab-item {{currentCategory === 'sleep' ? 'active' : ''}}" 
          bindtap="switchCategory" data-category="sleep">
      <text>{{texts.tasks.categories.sleep}}</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä»»åŠ¡åˆ—è¡¨ -->
  <view class="tasks-list" wx:if="{{!loading}}">
    <!-- è¿‡æ»¤åçš„ä»»åŠ¡ -->
    <view class="task-group" wx:if="{{filteredTasks.length > 0}}">
      <view class="group-header">
        <text class="group-title">{{currentCategory === 'all' ? 'å…¨éƒ¨ä»»åŠ¡' : categoryNames[currentCategory] + 'ä»»åŠ¡'}}</text>
        <text class="group-progress">{{filteredCompletedCount}}/{{filteredTotalCount}}</text>
      </view>
      
      <view class="task-item {{item.completed ? 'completed' : ''}}" 
            wx:for="{{filteredTasks}}" wx:key="id"
            bindtap="toggleTask" data-id="{{item.id}}">
        <view class="task-checkbox {{item.completed ? 'checked' : ''}}">
          <image wx:if="{{item.completed}}" class="check-icon" src="/images/icons/check.png"></image>
        </view>
        
        <view class="task-content">
          <view class="task-header">
            <text class="task-title">{{item.title}}</text>
            <view class="task-category {{item.category}}">{{item.categoryText}}</view>
          </view>
          <text class="task-description">{{item.description}}</text>
          <view class="task-footer">
            <view class="task-reward">
              <image class="reward-icon" src="/images/icons/exp.png"></image>
              <text>+{{item.reward}}ç»éªŒ</text>
            </view>
            <text class="task-time">{{item.deadline}}</text>
          </view>
        </view>
        
        <view class="task-action" wx:if="{{!item.completed}}">
          <button class="action-btn" bindtap="startTask" data-id="{{item.id}}" catchtap="startTask">
            {{item.type === 'check' ? 'æ‰“å¡' : 'å¼€å§‹'}}
          </button>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && todayTasks.length === 0 && weeklyTasks.length === 0}}">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-title">æš‚æ— å¥åº·ä»»åŠ¡</text>
      <text class="empty-desc">æ•°æ®åº“å¯èƒ½æœªåˆå§‹åŒ–ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›è¡Œåˆå§‹åŒ–</text>
      <button class="init-btn" bindtap="initializeDatabase">åˆå§‹åŒ–æ•°æ®åº“</button>
      <button class="refresh-btn" bindtap="refreshTasks">åˆ·æ–°ä»»åŠ¡</button>
    </view>
    
    <!-- è¿‡æ»¤åçš„ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && (todayTasks.length > 0 || weeklyTasks.length > 0) && filteredTasks.length === 0}}">
      <view class="empty-icon">ğŸ”</view>
      <text class="empty-title">æš‚æ— {{currentCategory === 'all' ? '' : categoryNames[currentCategory]}}ä»»åŠ¡</text>
      <text class="empty-desc">åˆ‡æ¢å…¶ä»–åˆ†ç±»æŸ¥çœ‹æ›´å¤šä»»åŠ¡</text>
      <button class="refresh-btn" bindtap="refreshTasks">åˆ·æ–°ä»»åŠ¡</button>
    </view>
  </view>

  <!-- æµ®åŠ¨åˆ·æ–°æŒ‰é’® -->
  <view class="fab-container">
    <button class="fab-btn" bindtap="refreshTasks">
      <image class="fab-icon" src="/images/icons/sync.png"></image>
    </button>
  </view>

  <!-- ä»»åŠ¡å®Œæˆæç¤º -->
  <view class="completion-modal" wx:if="{{showCompletionModal}}">
    <view class="modal-content">
      <image class="success-icon" src="/images/icons/success.png"></image>
      <text class="modal-title">ä»»åŠ¡å®Œæˆï¼</text>
      <text class="modal-message">è·å¾— {{completedTaskReward}} ç»éªŒå€¼</text>
      <text class="pet-message">{{petCongratulation}}</text>
      <button class="modal-btn" bindtap="closeCompletionModal">ç»§ç»­åŠ æ²¹</button>
    </view>
  </view>
</view>